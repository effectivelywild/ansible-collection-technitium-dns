#!/bin/bash

# Get current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Check if we're on main branch
if [[ "$BRANCH" == "main" ]]; then
    # Get the commit message
    COMMIT_MSG_FILE="$1"
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE" 2>/dev/null || echo "")
    
    # Check if commit message has bypass tag
    if [[ "$COMMIT_MSG" != *"[allow-main]"* ]]; then
        echo "❌ Direct commits to main branch are blocked!"
        echo ""
        echo "Please create a feature branch instead:"
        echo "  git checkout -b feature/your-feature-name"
        echo ""
        echo "Or add [allow-main] tag to commit message for emergencies:"
        echo "  git commit -m 'fix: urgent hotfix [allow-main]'"
        echo ""
        exit 1
    fi
    
    echo "⚠️  Bypassing main branch protection with [allow-main] tag"
fi

exit 0