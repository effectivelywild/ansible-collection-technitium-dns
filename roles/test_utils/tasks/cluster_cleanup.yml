---
- name: "Cleanup: Login to secondary01 to get valid token"
  effectivelywild.technitium_dns.technitium_dns_login:
    api_url: "{{ technitium_api_url_5 }}"
    api_port: "{{ technitium_api_port_5 }}"
    username: "{{ admin_username }}"
    password: "{{ admin_password }}"
  register: secondary01_login_cleanup
  until:  secondary01_login_cleanup is success
  retries: 3
  delay: 20
  ignore_errors: true

- name: "Cleanup: Update token fact for secondary01"
  ansible.builtin.set_fact:
    technitium_api_token_5: "{{ secondary01_login_cleanup.token }}"
  when: secondary01_login_cleanup is not failed

- name: "Cleanup: Leave cluster on secondary01 if joined"
  effectivelywild.technitium_dns.technitium_dns_leave_cluster:
    api_url: "{{ technitium_api_url_5 }}"
    api_token: "{{ technitium_api_token_5 }}"
    api_port: "{{ technitium_api_port_5 }}"
    force_leave: true
  register: secondary01_leave_cleanup
  until:  secondary01_leave_cleanup is success
  retries: 3
  delay: 20
  ignore_errors: true

- name: "Cleanup: Login to secondary02 to get valid token"
  effectivelywild.technitium_dns.technitium_dns_login:
    api_url: "{{ technitium_api_url_6 }}"
    api_port: "{{ technitium_api_port_6 }}"
    username: "{{ admin_username }}"
    password: "{{ admin_password }}"
  register:  secondary02_login_cleanup
  until:  secondary02_login_cleanup is success
  retries: 3
  delay: 20

- name: "Cleanup: Update token fact for secondary02"
  ansible.builtin.set_fact:
    technitium_api_token_6: "{{ secondary02_login_cleanup.token }}"
  when: secondary02_login_cleanup is not failed

- name: "Cleanup: Leave cluster on secondary02 if joined"
  effectivelywild.technitium_dns.technitium_dns_leave_cluster:
    api_url: "{{ technitium_api_url_6 }}"
    api_token: "{{ technitium_api_token_6 }}"
    api_port: "{{ technitium_api_port_6 }}"
    force_leave: true
  register: secondary02_leave_cleanup
  until:  secondary02_leave_cleanup is success
  retries: 3
  delay: 20

- name: "Cleanup: Get cluster state from Primary to find orphaned Secondaries"
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: "{{ technitium_api_url_4 }}"
    api_token: "{{ technitium_api_token_4 }}"
    api_port: "{{ technitium_api_port_4 }}"
  register: cleanup_state
  ignore_errors: true

- name: "Cleanup: Delete orphaned Secondaries from Primary if exist"
  effectivelywild.technitium_dns.technitium_dns_delete_secondary_node:
    api_url: "{{ technitium_api_url_4 }}"
    api_token: "{{ technitium_api_token_4 }}"
    api_port: "{{ technitium_api_port_4 }}"
    secondary_node_id: "{{ item.id }}"
  loop: "{{ cleanup_state.cluster_state.clusterNodes | selectattr('type', 'equalto', 'Secondary') | list }}"
  when:
    - cleanup_state is not failed
    - cleanup_state.cluster_state.clusterInitialized | default(false)
  ignore_errors: true

- name: "Cleanup: Delete existing cluster if initialized"
  effectivelywild.technitium_dns.technitium_dns_delete_cluster:
    api_url: "{{ technitium_api_url_4 }}"
    api_token: "{{ technitium_api_token_4 }}"
    api_port: "{{ technitium_api_port_4 }}"
  when: cleanup_state.cluster_state.clusterInitialized | default(false)
  register: cluster_delete_cleanup
  ignore_errors: true

- name: "Cleanup: Let cluster stabilize after deletion"
  ansible.builtin.pause:
    seconds: 10
  when: cluster_delete_cleanup is changed
