---
# Initialize a 3-node Technitium DNS cluster using collection modules
# This assumes containers are already created and tokens are available

- name: Initialize cluster on primary node
  effectivelywild.technitium_dns.technitium_dns_init_cluster:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    cluster_domain: "{{ cluster_domain }}"
    primary_node_ip_address: "{{ cluster_primary01_ip }}"
    validate_certs: no
  register: init_cluster_result

- name: Debug init cluster result
  debug:
    var: init_cluster_result
  when: debug | default(false)

- name: Join secondary node 1 to cluster
  effectivelywild.technitium_dns.technitium_dns_init_join_cluster:
    api_url: http://localhost
    api_token: "{{ token_cluster_secondary_01 }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    secondary_node_ip_address: "{{ cluster_secondary01_ip }}"
    primary_node_url: "http://{{ cluster_primary01_ip }}:{{ api_port_cluster_primary_01 }}"
    primary_node_ip_address: "{{ cluster_primary01_ip }}"
    primary_node_username: "{{ admin_username }}"
    primary_node_password: "{{ admin_password }}"
    ignore_certificate_errors: true
    validate_certs: no
  register: join_cluster_secondary_01_result

- name: Debug join cluster secondary 01 result
  debug:
    var: join_cluster_secondary_01_result
  when: debug | default(false)

- name: Join secondary node 2 to cluster
  effectivelywild.technitium_dns.technitium_dns_init_join_cluster:
    api_url: http://localhost
    api_token: "{{ token_cluster_secondary_02 }}"
    api_port: "{{ api_port_cluster_secondary_02 }}"
    secondary_node_ip_address: "{{ cluster_secondary02_ip }}"
    primary_node_url: "http://{{ cluster_primary01_ip }}:{{ api_port_cluster_primary_01 }}"
    primary_node_ip_address: "{{ cluster_primary01_ip }}"
    primary_node_username: "{{ admin_username }}"
    primary_node_password: "{{ admin_password }}"
    ignore_certificate_errors: true
    validate_certs: no
  register: join_cluster_secondary_02_result

- name: Debug join cluster secondary 02 result
  debug:
    var: join_cluster_secondary_02_result
  when: debug | default(false)

- name: Wait for cluster to stabilize
  pause:
    seconds: 5

- name: Verify cluster state
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    validate_certs: no
  register: cluster_state

- name: Debug cluster state
  debug:
    var: cluster_state
  when: debug | default(false)

- name: Assert cluster has 3 members
  assert:
    that:
      - cluster_state.cluster_state.clusterNodes | length == 3
    fail_msg: "Cluster should have 3 members but has {{ cluster_state.cluster_state.clusterNodes | length }}"
    success_msg: "Cluster initialized successfully with 3 nodes"
