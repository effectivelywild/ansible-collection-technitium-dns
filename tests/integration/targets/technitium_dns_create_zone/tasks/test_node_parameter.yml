---
# Integration tests for technitium_dns_create_zone node parameter (cluster support)

# Setup testing environment
- name: Include setup_cluster_testing_environment for setup
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "setup"

# Test 1: Create Primary zone on specific node
- name: Create Primary zone on primary node
  technitium_dns_create_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-createzone-primary.local"
    type: "Primary"
    node: "cluster_primary01"
    validate_certs: no
  register: create_zone_primary

- name: Assert create zone on primary succeeded
  assert:
    that:
      - not create_zone_primary.failed
      - create_zone_primary.changed
    fail_msg: "Create zone on primary node should succeed"

# Test 2: Verify zone exists using get_zone_info with node parameter
- name: Get zone info on primary node
  technitium_dns_get_zone_info:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-createzone-primary.local"
    node: "cluster_primary01"
    validate_certs: no
  register: zone_info_primary

- name: Assert zone exists on primary node
  assert:
    that:
      - not zone_info_primary.failed
      - zone_info_primary.zones is defined
      - zone_info_primary.zones | length == 1
      - zone_info_primary.zones[0].name == "test-createzone-primary.local"
    fail_msg: "Zone should exist on primary node after creation"

# Test 3: Idempotency - try to create same zone again
- name: Try to create same zone again (idempotency test)
  technitium_dns_create_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-createzone-primary.local"
    type: "Primary"
    node: "cluster_primary01"
    validate_certs: no
  register: create_zone_idempotent

- name: Assert creating already existing zone is idempotent
  assert:
    that:
      - not create_zone_idempotent.failed
      - not create_zone_idempotent.changed
    fail_msg: "Creating already existing zone should be idempotent"

# Test 4: Create Forwarder zone on specific node
- name: Create Forwarder zone on primary node
  technitium_dns_create_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-createzone-forwarder.local"
    type: "Forwarder"
    node: "cluster_primary01"
    forwarder: "8.8.8.8"
    initializeForwarder: true
    protocol: "Udp"
    validate_certs: no
  register: create_forwarder_zone

- name: Assert create forwarder zone succeeded
  assert:
    that:
      - not create_forwarder_zone.failed
      - create_forwarder_zone.changed
    fail_msg: "Create forwarder zone on primary node should succeed"

# Cleanup
- name: Delete Primary test zone
  technitium_dns_delete_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-createzone-primary.local"
    node: "cluster_primary01"
    validate_certs: no
  ignore_errors: yes

- name: Delete Forwarder test zone
  technitium_dns_delete_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-createzone-forwarder.local"
    node: "cluster_primary01"
    validate_certs: no
  ignore_errors: yes

- name: Include setup_cluster_testing_environment for teardown
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "teardown"
