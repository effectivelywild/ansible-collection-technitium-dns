---
# Integration test suite for technitium_dns_list_store_apps
# This test validates listing available apps from DNS App Store by:
# 1. Listing store apps
# 2. Verifying the response structure
# 3. Testing with invalid credentials
# 4. Checking for expected app properties

# Phase 1: Setup - Load configuration
- name: "Load test configuration"
  include_vars: ../../integration_config.yml

# Phase 2: List all store apps
- name: "List all available apps from DNS App Store"
  technitium_dns_list_store_apps:
    api_url: "{{ technitium_api_url_2 }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | int }}"
    validate_certs: "{{ validate_certs }}"
  register: list_store_apps_result

- name: "Debug list store apps result"
  debug:
    var: list_store_apps_result
  when: debug | default(false)

- name: "Assert list store apps succeeded"
  assert:
    that:
      - not list_store_apps_result.failed
      - not list_store_apps_result.changed
      - list_store_apps_result.store_apps is defined
      - list_store_apps_result.store_apps is iterable
    fail_msg: "List store apps should have succeeded and returned a list"

# Phase 3: Verify store app structure
- name: "Verify store app structure"
  assert:
    that:
      - item.name is defined
      - item.version is defined
      - item.description is defined
      - item.url is defined
      - item.size is defined
      - item.installed is defined
    fail_msg: "Each store app should have required properties"
  loop: "{{ list_store_apps_result.store_apps }}"

# Phase 4: Check for installed apps with update info
- name: "Find installed apps in store list"
  set_fact:
    installed_store_apps: "{{ list_store_apps_result.store_apps | selectattr('installed', 'equalto', true) | list }}"

- name: "Debug installed store apps"
  debug:
    var: installed_store_apps
  when: debug | default(false)

- name: "Verify installed apps have version info"
  assert:
    that:
      - item.installedVersion is defined
      - item.updateAvailable is defined
    fail_msg: "Installed apps should have installedVersion and updateAvailable"
  loop: "{{ installed_store_apps }}"

# Phase 5: Test failure cases
- name: "Test list store apps with invalid API token"
  technitium_dns_list_store_apps:
    api_url: "{{ technitium_api_url_2 }}"
    api_token: "invalid_token_12345"
    api_port: "{{ technitium_api_port_2 | int }}"
    validate_certs: "{{ validate_certs }}"
  register: invalid_token_result
  ignore_errors: true

- name: "Assert failure with invalid API token"
  assert:
    that:
      - invalid_token_result.failed
      - "'Invalid token' in (invalid_token_result.msg) or 'Technitium API error' in (invalid_token_result.msg)"
    fail_msg: "Invalid token should cause failure"
