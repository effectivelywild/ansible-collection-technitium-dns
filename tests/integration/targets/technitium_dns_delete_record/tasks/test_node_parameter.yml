---
# Integration tests for technitium_dns_delete_record node parameter (cluster support)

# Setup testing environment with cluster initialization
- name: Include setup_cluster_testing_environment for setup
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "setup"
    initialize_cluster: true

# Setup: Create a test zone and add records
- name: Create test zone on primary node
  technitium_dns_create_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-deleterecord.local"
    type: "Primary"
    validate_certs: no

- name: Add A record for deletion test
  technitium_dns_add_record:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "www.test-deleterecord.local"
    zone: "test-deleterecord.local"
    type: "A"
    ipAddress: "192.0.2.10"
    ttl: 3600
    validate_certs: no

- name: Add TXT record for deletion test
  technitium_dns_add_record:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "test-deleterecord.local"
    zone: "test-deleterecord.local"
    type: "TXT"
    text: "v=spf1 include:_spf.example.com ~all"
    ttl: 3600
    validate_certs: no

- name: Add MX record for deletion test
  technitium_dns_add_record:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "test-deleterecord.local"
    zone: "test-deleterecord.local"
    type: "MX"
    exchange: "mail.test-deleterecord.local"
    preference: 10
    ttl: 3600
    validate_certs: no

# Test 1: Delete A record on specific node
- name: Delete A record on primary node
  technitium_dns_delete_record:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "www.test-deleterecord.local"
    zone: "test-deleterecord.local"
    node: "cluster-primary01.example.com"
    type: "A"
    ipAddress: "192.0.2.10"
    validate_certs: no
  register: delete_a_record

- name: Assert A record deleted successfully
  assert:
    that:
      - not delete_a_record.failed
      - delete_a_record.changed
    fail_msg: "Delete A record on primary node should succeed"

# Test 2: Delete TXT record on specific node
- name: Delete TXT record on primary node
  technitium_dns_delete_record:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "test-deleterecord.local"
    zone: "test-deleterecord.local"
    node: "cluster-primary01.example.com"
    type: "TXT"
    text: "v=spf1 include:_spf.example.com ~all"
    validate_certs: no
  register: delete_txt_record

- name: Assert TXT record deleted successfully
  assert:
    that:
      - not delete_txt_record.failed
      - delete_txt_record.changed
    fail_msg: "Delete TXT record on primary node should succeed"

# Test 3: Idempotency - try to delete already deleted A record
- name: Try to delete already deleted A record
  technitium_dns_delete_record:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "www.test-deleterecord.local"
    zone: "test-deleterecord.local"
    node: "cluster-primary01.example.com"
    type: "A"
    ipAddress: "192.0.2.10"
    validate_certs: no
  register: delete_a_record_again

- name: Assert deleting already deleted record is idempotent
  assert:
    that:
      - not delete_a_record_again.failed
      - not delete_a_record_again.changed
    fail_msg: "Deleting already deleted record should be idempotent"

# Test 4: Delete MX record on specific node
- name: Delete MX record on primary node
  technitium_dns_delete_record:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "test-deleterecord.local"
    zone: "test-deleterecord.local"
    node: "cluster-primary01.example.com"
    type: "MX"
    exchange: "mail.test-deleterecord.local"
    preference: 10
    validate_certs: no
  register: delete_mx_record

- name: Assert MX record deleted successfully
  assert:
    that:
      - not delete_mx_record.failed
      - delete_mx_record.changed
    fail_msg: "Delete MX record on primary node should succeed"

# Test 5: Negative test - invalid node name
- name: Add record for negative test
  technitium_dns_add_record:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "negative.test-deleterecord.local"
    zone: "test-deleterecord.local"
    type: "A"
    ipAddress: "192.0.2.99"
    validate_certs: no

- name: Try to delete record with invalid node name
  technitium_dns_delete_record:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "negative.test-deleterecord.local"
    zone: "test-deleterecord.local"
    node: "invalid-node-name-xyz"
    type: "A"
    ipAddress: "192.0.2.99"
    validate_certs: no
  register: delete_record_invalid_node
  ignore_errors: true

- name: Assert deletion with invalid node fails
  assert:
    that:
      - delete_record_invalid_node.failed
      - "'No such node exists' in delete_record_invalid_node.msg"
    fail_msg: "Delete with invalid node name should fail with appropriate error"

- name: Include setup_cluster_testing_environment for teardown
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "teardown"
