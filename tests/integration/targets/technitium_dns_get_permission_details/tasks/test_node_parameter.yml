---
# Integration tests for technitium_dns_get_permission_details node parameter (cluster support)

# Setup testing environment with cluster initialization
- name: Include setup_cluster_testing_environment for setup
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "setup"
    initialize_cluster: true

# Test 1: Get permission details on primary node with explicit node parameter
- name: Get Dashboard permission details on primary node
  technitium_dns_get_permission_details:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    section: "Dashboard"
    includeUsersAndGroups: true
    node: "cluster-primary01.example.com"
    validate_certs: no
  register: get_permission_primary

- name: Assert get permission details on primary node succeeded
  assert:
    that:
      - not get_permission_primary.failed
      - not get_permission_primary.changed
      - get_permission_primary.permission_details is defined
      - get_permission_primary.permission_details.section == "Dashboard"
      - get_permission_primary.permission_details.groupPermissions is defined
      - get_permission_primary.permission_details.userPermissions is defined
    fail_msg: "Get permission details on primary node should succeed"

# Test 2: Verify Administrators group has full permissions
- name: Verify Administrators group permissions
  assert:
    that:
      - admin_group is defined
      - admin_group.name == "Administrators"
      - admin_group.canView == true
      - admin_group.canModify == true
      - admin_group.canDelete == true
    fail_msg: "Administrators group should have full Dashboard permissions"
  vars:
    admin_group: "{{ get_permission_primary.permission_details.groupPermissions | selectattr('name', 'equalto', 'Administrators') | first }}"

# Test 3: Get permission details without users and groups list
- name: Get Zones permission details without users/groups list
  technitium_dns_get_permission_details:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    section: "Zones"
    includeUsersAndGroups: false
    node: "cluster-primary01.example.com"
    validate_certs: no
  register: get_permission_no_lists

- name: Assert permission details without lists succeeded
  assert:
    that:
      - not get_permission_no_lists.failed
      - not get_permission_no_lists.changed
      - get_permission_no_lists.permission_details.section == "Zones"
      - get_permission_no_lists.permission_details.users is not defined or get_permission_no_lists.permission_details.users | length == 0
      - get_permission_no_lists.permission_details.groups is not defined or get_permission_no_lists.permission_details.groups | length == 0
    fail_msg: "Permission details without users/groups list should work"

# Test 4: Negative test - invalid node name
- name: Try to get permission details with invalid node name
  technitium_dns_get_permission_details:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    section: "Dashboard"
    node: "invalid-node-name-xyz"
    validate_certs: no
  register: get_permission_invalid_node
  ignore_errors: true

- name: Assert get permission details with invalid node fails
  assert:
    that:
      - get_permission_invalid_node.failed
      - "'No such node exists' in get_permission_invalid_node.msg"
    fail_msg: "Get permission details with invalid node name should fail with appropriate error"

- name: Include setup_cluster_testing_environment for teardown
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "teardown"
