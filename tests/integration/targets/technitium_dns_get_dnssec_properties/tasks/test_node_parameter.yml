---
# Integration tests for technitium_dns_get_dnssec_properties node parameter (cluster support)

# Setup testing environment with cluster initialization
- name: Include setup_cluster_testing_environment for setup
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "setup"
    initialize_cluster: true

# Setup: Create and sign a test zone on primary
- name: Create test zone on primary node
  technitium_dns_create_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-dnssecprops.local"
    type: "Primary"
    validate_certs: no

- name: Sign test zone on primary node
  technitium_dns_sign_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-dnssecprops.local"
    node: "cluster-primary01.example.com"
    algorithm: "ECDSA"
    curve: "P256"
    dnsKeyTtl: 86400
    zskRolloverDays: 30
    nxProof: "NSEC"
    validate_certs: no

# Test 1: Get DNSSEC properties without node parameter (default behavior - current node)
- name: Get DNSSEC properties without node parameter
  technitium_dns_get_dnssec_properties:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-dnssecprops.local"
    validate_certs: no
  register: dnssec_props_default

- name: Assert default DNSSEC properties returned
  assert:
    that:
      - not dnssec_props_default.failed
      - dnssec_props_default.dnssec_properties is defined
      - dnssec_props_default.dnssec_properties.dnssecStatus is defined
      - dnssec_props_default.dnssec_properties.dnssecStatus == "SignedWithNSEC"
      - dnssec_props_default.dnssec_properties.dnsKeyTtl == 86400
    fail_msg: "DNSSEC properties retrieval without node parameter should succeed"

# Test 2: Get DNSSEC properties for specific node (primary)
- name: Get DNSSEC properties for primary node
  technitium_dns_get_dnssec_properties:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-dnssecprops.local"
    node: "cluster-primary01.example.com"
    validate_certs: no
  register: dnssec_props_primary

- name: Assert primary node DNSSEC properties returned
  assert:
    that:
      - not dnssec_props_primary.failed
      - dnssec_props_primary.dnssec_properties is defined
      - dnssec_props_primary.dnssec_properties.dnssecStatus is defined
      - dnssec_props_primary.dnssec_properties.dnssecStatus == "SignedWithNSEC"
      - dnssec_props_primary.dnssec_properties.dnsKeyTtl == 86400
    fail_msg: "DNSSEC properties retrieval for primary node should succeed"

# Test 3: Get DNSSEC properties for unsigned zone
- name: Create unsigned test zone
  technitium_dns_create_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-unsigned.local"
    type: "Primary"
    validate_certs: no

- name: Get DNSSEC properties for unsigned zone on primary node
  technitium_dns_get_dnssec_properties:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-unsigned.local"
    node: "cluster-primary01.example.com"
    validate_certs: no
  register: dnssec_props_unsigned

- name: Assert unsigned zone DNSSEC properties
  assert:
    that:
      - not dnssec_props_unsigned.failed
      - dnssec_props_unsigned.dnssec_properties is defined
      - dnssec_props_unsigned.dnssec_properties.dnssecStatus == "Unsigned"
    fail_msg: "DNSSEC properties for unsigned zone should show Unsigned status"

# Cleanup
- name: Delete signed test zone
  technitium_dns_delete_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-dnssecprops.local"
    validate_certs: no
  ignore_errors: yes

- name: Delete unsigned test zone
  technitium_dns_delete_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-unsigned.local"
    validate_certs: no
  ignore_errors: yes

- name: Include setup_cluster_testing_environment for teardown
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "teardown"
