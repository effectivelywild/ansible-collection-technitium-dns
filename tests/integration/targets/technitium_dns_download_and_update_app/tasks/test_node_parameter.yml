---
# Integration tests for technitium_dns_download_and_update_app node parameter (cluster support)

# Setup testing environment with cluster initialization
- name: Include setup_cluster_testing_environment for setup
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "setup"
    initialize_cluster: true

# Setup: First install an app so we can update it
- name: Install What Is My Dns app on primary node for testing
  technitium_dns_download_and_install_app:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "What Is My Dns"
    url: "https://download.technitium.com/dns/apps/WhatIsMyDnsApp.zip"
    node: "cluster-primary01.example.com"
    validate_certs: no
  register: install_app_for_update

# Test 1: Download and update app on primary node with explicit node parameter
- name: Download and update What Is My Dns app on primary node
  technitium_dns_download_and_update_app:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "What Is My Dns"
    url: "https://download.technitium.com/dns/apps/WhatIsMyDnsApp.zip"
    node: "cluster-primary01.example.com"
    validate_certs: no
  register: update_app_primary

- name: Assert update app on primary node succeeded
  assert:
    that:
      - not update_app_primary.failed
      - update_app_primary.updated_app is defined
      - update_app_primary.updated_app.name == "What Is My Dns"
      - update_app_primary.updated_app.version is defined
    fail_msg: "Update app on primary node should succeed"

# Test 2: Test idempotency - update again with same version
- name: Try to update What Is My Dns app again (idempotency test)
  technitium_dns_download_and_update_app:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "What Is My Dns"
    url: "https://download.technitium.com/dns/apps/WhatIsMyDnsApp.zip"
    node: "cluster-primary01.example.com"
    validate_certs: no
  register: update_app_idempotent

- name: Assert idempotency
  assert:
    that:
      - not update_app_idempotent.failed
      - not update_app_idempotent.changed
      - "'already at version' in update_app_idempotent.msg | lower"
    fail_msg: "Second update with same version should be idempotent"

# Test 3: Negative test - invalid node name
- name: Try to update app with invalid node name
  technitium_dns_download_and_update_app:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "What Is My Dns"
    url: "https://download.technitium.com/dns/apps/WhatIsMyDnsApp.zip"
    node: "invalid-node-name-xyz"
    validate_certs: no
  register: update_app_invalid_node
  ignore_errors: true

- name: Assert update app with invalid node fails
  assert:
    that:
      - update_app_invalid_node.failed
      - "'No such node exists' in update_app_invalid_node.msg"
    fail_msg: "Update app with invalid node name should fail with appropriate error"

- name: Include setup_cluster_testing_environment for teardown
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "teardown"
