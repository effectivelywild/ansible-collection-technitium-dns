---
# Integration tests for technitium_dns_list_groups node parameter (cluster support)

# Setup testing environment with cluster initialization
- name: Include setup_cluster_testing_environment for setup
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "setup"
    initialize_cluster: true

# Test 1: List groups on primary node with explicit node parameter
- name: List groups on primary node
  technitium_dns_list_groups:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    node: "cluster-primary01.example.com"
    validate_certs: no
  register: list_groups_primary

- name: Assert list groups on primary node succeeded
  assert:
    that:
      - not list_groups_primary.failed
      - not list_groups_primary.changed
      - list_groups_primary.groups is defined
      - list_groups_primary.groups | length > 0
    fail_msg: "List groups on primary node should succeed"

# Test 2: Verify Administrators group exists in cluster
- name: Check if Administrators group exists
  assert:
    that:
      - list_groups_primary.groups | selectattr('name', 'equalto', 'Administrators') | list | length > 0
    fail_msg: "Administrators group should exist in the group list"

# Test 3: Negative test - invalid node name
- name: Try to list groups with invalid node name
  technitium_dns_list_groups:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    node: "invalid-node-name-xyz"
    validate_certs: no
  register: list_groups_invalid_node
  ignore_errors: true

- name: Assert list groups with invalid node fails
  assert:
    that:
      - list_groups_invalid_node.failed
      - "'No such node exists' in list_groups_invalid_node.msg"
    fail_msg: "List groups with invalid node name should fail with appropriate error"

- name: Include setup_cluster_testing_environment for teardown
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "teardown"
