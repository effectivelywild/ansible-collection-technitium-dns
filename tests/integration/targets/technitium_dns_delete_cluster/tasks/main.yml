---
# Setup testing environment
- name: Include setup_cluster_testing_environment for setup
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "setup"

# Setup - Initialize cluster
- name: "Setup: Initialize cluster on Primary node"
  effectivelywild.technitium_dns.technitium_dns_init_cluster:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    cluster_domain: "example.com"
    primary_node_ip_address: "{{ cluster_primary01_ip }}"
  register: init_primary_result

- name: "Print cluster initialization result"
  ansible.builtin.debug:
    var: init_primary_result

- name: "Setup: Wait for cluster to initialize"
  ansible.builtin.pause:
    seconds: 10

# Test 1: Delete empty cluster (no Secondary nodes)
- name: "Test 1: Delete cluster with no secondary01 node"
  effectivelywild.technitium_dns.technitium_dns_delete_cluster:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
  register: delete_result

- name: "Test 1.1: Assert cluster was deleted"
  assert:
    that:
      - delete_result is not failed
      - delete_result.changed == true
      - delete_result.cluster_state is defined
      - delete_result.cluster_state.clusterInitialized == false
      - delete_result.msg == "Cluster deleted successfully"

- name: "Setup: Wait for cluster to delete"
  ansible.builtin.pause:
    seconds: 10

# Test 2: Idempotency - Delete again
- name: "Test 2: Idempotent - Try to delete cluster again"
  effectivelywild.technitium_dns.technitium_dns_delete_cluster:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
  register: idempotent_result

- name: "Test 2.1: Assert no changes made (idempotent)"
  assert:
    that:
      - idempotent_result is not failed
      - idempotent_result.changed == false
      - "'Cluster is not initialized' in idempotent_result.msg"

# Test 3: Check mode
- name: "Test 3: Re-initialize cluster"
  effectivelywild.technitium_dns.technitium_dns_init_cluster:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    cluster_domain: "example.com"
    primary_node_ip_address: "{{ cluster_primary01_ip }}"

- name: "Test 3.1: Delete cluster in check mode"
  effectivelywild.technitium_dns.technitium_dns_delete_cluster:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
  check_mode: true
  register: check_mode_result

- name: "Test 3.2: Assert check mode reports changes but doesn't delete"
  assert:
    that:
      - check_mode_result is not failed
      - check_mode_result.changed == true
      - "'Would delete cluster' in check_mode_result.msg"

- name: "Test 3.3: Verify cluster was not actually deleted"
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
  register: verify_not_deleted

- name: "Test 3.4: Assert cluster is still initialized"
  assert:
    that:
      - verify_not_deleted.cluster_state.clusterInitialized == true

# Test 4: Negative test - Try to delete cluster with Secondary nodes (should fail)
- name: "Test 4: Wait for cluster to initialize"
  ansible.builtin.pause:
    seconds: 10

- name: "Test 4.1: Join secondary01 node to cluster"
  effectivelywild.technitium_dns.technitium_dns_init_join_cluster:
    api_url: http://localhost
    api_token: "{{ token_cluster_secondary_01 }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    secondary_node_ip_address: "{{ secondary_node_ip_address_01 }}"
    primary_node_ip_address: "{{ cluster_primary01_ip }}"
    primary_node_url: "https://cluster_primary01{{ container_suffix }}:{{ https_port_cluster_primary_01 }}/"
    primary_node_username: "{{ admin_username }}"
    primary_node_password: "{{ admin_password }}"
    ignore_certificate_errors: true

- name: "Test 4.2: Try to delete cluster with Secondary nodes (should fail)"
  effectivelywild.technitium_dns.technitium_dns_delete_cluster:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
  register: negative_result
  ignore_errors: true

- name: "Test 4.3: Assert failure when trying to delete with Secondary nodes"
  assert:
    that:
      - negative_result is failed
      - "'Failed to delete cluster' in negative_result.msg"
      - "'please remove all Secondary nodes' in negative_result.msg"

# Test 5: Force delete with Secondary nodes
- name: "Test 5: Force delete cluster with Secondary nodes"
  effectivelywild.technitium_dns.technitium_dns_delete_cluster:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    force_delete: true
  register: force_delete_result

- name: "Test 5.1: Assert force delete succeeded"
  assert:
    that:
      - force_delete_result is not failed
      - force_delete_result.changed == true
      - force_delete_result.cluster_state.clusterInitialized == false

- name: "Test 5.2: Wait for cluster to delete"
  ansible.builtin.pause:
    seconds: 10

- name: "Test 5.3: Login to Secondary node to check if orphaned"
  effectivelywild.technitium_dns.technitium_dns_login:
    api_url: http://localhost
    api_port: "{{ api_port_cluster_secondary_01 }}"
    username: "{{ admin_username }}"
    password: "{{ admin_password }}"
  register: orphaned_login

- name: "Test 5.4: Verify Secondary is still part of cluster (orphaned)"
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: http://localhost
    api_token: "{{ orphaned_login.token }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
  register: orphaned_state

- name: "Test 5.5: Assert Secondary is still initialized (orphaned)"
  assert:
    that:
      - orphaned_state.cluster_state.clusterInitialized == true

# Test 6: Negative test - Try to delete from Secondary node
- name: "Test 6: Re-initialize cluster"
  effectivelywild.technitium_dns.technitium_dns_init_cluster:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    cluster_domain: "example.com"
    primary_node_ip_address: "{{ cluster_primary01_ip }}"

- name: "Test 6.1: Force leave orphaned Secondary"
  effectivelywild.technitium_dns.technitium_dns_leave_cluster:
    api_url: http://localhost
    api_token: "{{ orphaned_login.token }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    force_leave: true

- name: "Test 6.2: Join Secondary to new cluster"
  effectivelywild.technitium_dns.technitium_dns_init_join_cluster:
    api_url: http://localhost
    api_token: "{{ orphaned_login.token }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    secondary_node_ip_address: "{{ secondary_node_ip_address_01 }}"
    primary_node_ip_address: "{{ cluster_primary01_ip }}"
    primary_node_url: "https://cluster_primary01{{ container_suffix }}:{{ https_port_cluster_primary_01 }}/"
    primary_node_username: "{{ admin_username }}"
    primary_node_password: "{{ admin_password }}"
    ignore_certificate_errors: true

- name: "Test 6.3: Login to Secondary again"
  effectivelywild.technitium_dns.technitium_dns_login:
    api_url: http://localhost
    api_port: "{{ api_port_cluster_secondary_01 }}"
    username: "{{ admin_username }}"
    password: "{{ admin_password }}"
  register: secondary_login_test6

- name: "Test 6.4: Try to delete cluster from Secondary node (should fail)"
  effectivelywild.technitium_dns.technitium_dns_delete_cluster:
    api_url: http://localhost
    api_token: "{{ secondary_login_test6.token }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
  register: negative_secondary_result
  ignore_errors: true

- name: "Test 6.5: Assert failure when trying to delete from Secondary"
  assert:
    that:
      - negative_secondary_result is failed
      - "'only a Primary node can delete the Cluster' in negative_secondary_result.msg"

# Cleanup
- name: Include setup_cluster_testing_environment for setup
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "teardown"