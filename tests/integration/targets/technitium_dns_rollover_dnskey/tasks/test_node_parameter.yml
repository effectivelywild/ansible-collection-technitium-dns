---
# Integration tests for technitium_dns_rollover_dnskey node parameter (cluster support)

# Setup testing environment with cluster initialization
- name: Include setup_cluster_testing_environment for setup
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "setup"
    initialize_cluster: true

# Setup: Create and sign a zone
- name: Create test zone on primary node
  technitium_dns_create_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-rollover.local"
    type: "Primary"
    validate_certs: no

- name: Sign zone with DNSSEC
  technitium_dns_sign_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-rollover.local"
    algorithm: "ECDSAP256SHA256"
    validate_certs: no
  register: sign_result

- name: Wait for DNSSEC keys to become active
  pause:
    seconds: 3

- name: Get DNSSEC properties to find key tag
  technitium_dns_get_dnssec_properties:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-rollover.local"
    validate_certs: no
  register: dnssec_props

- name: Extract first key tag
  set_fact:
    first_key_tag: "{{ dnssec_props.dnssec_properties.dnssecPrivateKeys[0].keyTag }}"

# Test 1: Rollover DNSKEY on specific node
- name: Rollover DNSKEY on primary node
  technitium_dns_rollover_dnskey:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-rollover.local"
    key_tag: "{{ first_key_tag }}"
    node: "cluster-primary01.example.com"
    validate_certs: no
  register: rollover_primary

- name: Assert DNSKEY rollover on primary node succeeded
  assert:
    that:
      - not rollover_primary.failed
      - rollover_primary.changed
      - rollover_primary.key_tag == first_key_tag | int
    fail_msg: "Rollover DNSKEY on primary node should succeed"

# Test 2: Verify new key was created
- name: Get DNSSEC properties after rollover
  technitium_dns_get_dnssec_properties:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-rollover.local"
    validate_certs: no
  register: dnssec_props_after

- name: Assert new key was generated
  assert:
    that:
      - dnssec_props_after.dnssec_properties.dnssecPrivateKeys | length > dnssec_props.dnssec_properties.dnssecPrivateKeys | length
    fail_msg: "Rollover should create a new DNSKEY"

# Test 3: Negative test - invalid node name
- name: Try to rollover DNSKEY with invalid node name
  technitium_dns_rollover_dnskey:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-rollover.local"
    key_tag: "{{ first_key_tag }}"
    node: "invalid-node-name-xyz"
    validate_certs: no
  register: rollover_invalid_node
  ignore_errors: yes

- name: Assert rollover with invalid node fails
  assert:
    that:
      - rollover_invalid_node.failed
      - "'No such node exists' in rollover_invalid_node.msg"
    fail_msg: "Rollover DNSKEY with invalid node name should fail with appropriate error"

# Cleanup
- name: Delete test zone
  technitium_dns_delete_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-rollover.local"
    validate_certs: no
  ignore_errors: yes

- name: Include setup_cluster_testing_environment for teardown
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "teardown"
