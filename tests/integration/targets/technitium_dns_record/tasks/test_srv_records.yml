---
# SRV Record Integration Tests
# SRV (Service) records define the location of services
# They support multiple records per DNS name
# Format: _service._protocol.name priority weight port target

# Test 1: Basic SRV record using shorthand syntax
- name: "Test 1.1: Create basic SRV record using shorthand"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_sip._tcp.srv-basic.{{ primary_zone_name }}"
    type: SRV
    priority: 10
    weight: 5
    srv_port: 5060
    target: "sip1.example.com"
    state: present
  register: srv_basic_result

- name: "Test 1.2: Assert SRV record was created"
  ansible.builtin.assert:
    that:
      - srv_basic_result.changed

- name: "Test 1.3: Verify SRV record exists"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_sip._tcp.srv-basic.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: srv_basic_get

- name: "Test 1.4: Assert SRV values match"
  ansible.builtin.assert:
    that:
      - srv_basic_get.records | selectattr('type', 'equalto', 'SRV') | list | length == 1
      - (srv_basic_get.records | selectattr('type', 'equalto', 'SRV') | first).rData.priority == 10
      - (srv_basic_get.records | selectattr('type', 'equalto', 'SRV') | first).rData.weight == 5
      - (srv_basic_get.records | selectattr('type', 'equalto', 'SRV') | first).rData.port == 5060
      - (srv_basic_get.records | selectattr('type', 'equalto', 'SRV') | first).rData.target == "sip1.example.com"

- name: "Test 1.5: Re-create SRV record (idempotency)"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_sip._tcp.srv-basic.{{ primary_zone_name }}"
    type: SRV
    records:
      - priority: 10
        weight: 5
        srv_port: 5060
        target: "sip1.example.com"
    overwrite: true
    state: present
  register: srv_basic_idempotent

- name: "Test 1.6: Assert idempotency (no change)"
  ansible.builtin.assert:
    that:
      - not srv_basic_idempotent.changed

# Test 2: Multiple SRV records for load balancing
- name: "Test 2.1: Create multiple SRV records using records list"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_http._tcp.srv-multi.{{ primary_zone_name }}"
    type: SRV
    records:
      - priority: 10
        weight: 60
        srv_port: 8080
        target: "web1.example.com"
      - priority: 10
        weight: 40
        srv_port: 8080
        target: "web2.example.com"
      - priority: 20
        weight: 100
        srv_port: 8080
        target: "web-backup.example.com"
    state: present
  register: srv_multi_result

- name: "Test 2.2: Assert SRV records created"
  ansible.builtin.assert:
    that:
      - srv_multi_result.changed

- name: "Test 2.3: Verify all three SRV records exist"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_http._tcp.srv-multi.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: srv_multi_get

- name: "Test 2.4: Assert all SRV records exist with correct values"
  ansible.builtin.assert:
    that:
      - srv_multi_get.records | selectattr('type', 'equalto', 'SRV') | list | length == 3
      - srv_multi_get.records | selectattr('type', 'equalto', 'SRV') | selectattr('rData.priority', 'equalto', 10) | list | length == 2
      - srv_multi_get.records | selectattr('type', 'equalto', 'SRV') | selectattr('rData.priority', 'equalto', 20) | list | length == 1
      - srv_multi_get.records | selectattr('type', 'equalto', 'SRV') | map(attribute='rData.target') | select('search', '^web1\\.') | list | length == 1
      - srv_multi_get.records | selectattr('type', 'equalto', 'SRV') | map(attribute='rData.target') | select('search', '^web2\\.') | list | length == 1
      - srv_multi_get.records | selectattr('type', 'equalto', 'SRV') | map(attribute='rData.target') | select('search', '^web-backup\\.') | list | length == 1

- name: "Test 2.5: Re-create all SRV records (idempotency)"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_http._tcp.srv-multi.{{ primary_zone_name }}"
    type: SRV
    records:
      - priority: 10
        weight: 60
        srv_port: 8080
        target: "web1.example.com"
      - priority: 10
        weight: 40
        srv_port: 8080
        target: "web2.example.com"
      - priority: 20
        weight: 100
        srv_port: 8080
        target: "web-backup.example.com"
    state: present
  register: srv_multi_idempotent

- name: "Test 2.6: Assert idempotency (no change)"
  ansible.builtin.assert:
    that:
      - not srv_multi_idempotent.changed

# Test 3: Overwrite mode
- name: "Test 3.1: Overwrite SRV records with new set"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_http._tcp.srv-multi.{{ primary_zone_name }}"
    type: SRV
    records:
      - priority: 5
        weight: 100
        srv_port: 9090
        target: "new-web.example.com"
    overwrite: true
    state: present
  register: srv_overwrite_result

- name: "Test 3.2: Assert overwrite changed"
  ansible.builtin.assert:
    that:
      - srv_overwrite_result.changed

- name: "Test 3.3: Verify only new SRV record exists"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_http._tcp.srv-multi.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: srv_overwrite_get

- name: "Test 3.4: Assert old SRV records removed, new one exists"
  ansible.builtin.assert:
    that:
      - srv_overwrite_get.records | selectattr('type', 'equalto', 'SRV') | list | length == 1
      - (srv_overwrite_get.records | selectattr('type', 'equalto', 'SRV') | first).rData.priority == 5
      - (srv_overwrite_get.records | selectattr('type', 'equalto', 'SRV') | first).rData.port == 9090
      - srv_overwrite_get.records | selectattr('type', 'equalto', 'SRV') | map(attribute='rData.target') | select('search', '^new-web\\.') | list | length == 1

# Test 4: Additive mode (overwrite=false)
- name: "Test 4.1: Add SRV record to existing set (additive)"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_http._tcp.srv-multi.{{ primary_zone_name }}"
    type: SRV
    priority: 10
    weight: 50
    srv_port: 9090
    target: "additional-web.example.com"
    overwrite: false
    state: present
  register: srv_additive_result

- name: "Test 4.2: Assert additive mode changed"
  ansible.builtin.assert:
    that:
      - srv_additive_result.changed

- name: "Test 4.3: Verify all SRV records exist (old + new)"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_http._tcp.srv-multi.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: srv_additive_get

- name: "Test 4.4: Assert all SRV records present"
  ansible.builtin.assert:
    that:
      - srv_additive_get.records | selectattr('type', 'equalto', 'SRV') | list | length == 2
      - srv_additive_get.records | selectattr('type', 'equalto', 'SRV') | map(attribute='rData.target') | select('search', '^new-web\\.') | list | length == 1
      - srv_additive_get.records | selectattr('type', 'equalto', 'SRV') | map(attribute='rData.target') | select('search', '^additional-web\\.') | list | length == 1

# Test 5: Selective deletion
- name: "Test 5.1: Delete specific SRV record by identifying fields"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_http._tcp.srv-multi.{{ primary_zone_name }}"
    type: SRV
    priority: 10
    weight: 50
    srv_port: 9090
    target: "additional-web.example.com"
    state: absent
  register: srv_delete_specific_result

- name: "Test 5.2: Assert specific SRV deleted"
  ansible.builtin.assert:
    that:
      - srv_delete_specific_result.changed

- name: "Test 5.3: Verify specific SRV record removed"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_http._tcp.srv-multi.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: srv_delete_specific_get

- name: "Test 5.4: Assert only additional SRV removed, new-web remains"
  ansible.builtin.assert:
    that:
      - srv_delete_specific_get.records | selectattr('type', 'equalto', 'SRV') | list | length == 1
      - srv_delete_specific_get.records | selectattr('type', 'equalto', 'SRV') | map(attribute='rData.target') | select('search', '^new-web\\.') | list | length == 1
      - srv_delete_specific_get.records | selectattr('type', 'equalto', 'SRV') | map(attribute='rData.target') | select('search', '^additional-web\\.') | list | length == 0

# Test 6: Delete all SRV records by name/type
- name: "Test 6.1: Delete all SRV records for name"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_http._tcp.srv-multi.{{ primary_zone_name }}"
    type: SRV
    state: absent
  register: srv_delete_all_result

- name: "Test 6.2: Assert all SRV records deleted"
  ansible.builtin.assert:
    that:
      - srv_delete_all_result.changed

- name: "Test 6.3: Verify no SRV records remain"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_http._tcp.srv-multi.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: srv_delete_all_get
  ignore_errors: true

- name: "Test 6.4: Assert no SRV records found"
  ansible.builtin.assert:
    that:
      - srv_delete_all_get.failed or (srv_delete_all_get.records | selectattr('type', 'equalto', 'SRV') | list | length == 0)

# Test 7: Check mode
- name: "Test 7.1: Create SRV record in check mode"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_ldap._tcp.srv-check.{{ primary_zone_name }}"
    type: SRV
    priority: 0
    weight: 100
    srv_port: 389
    target: "ldap.example.com"
    state: present
  check_mode: true
  register: srv_check_create

- name: "Test 7.2: Assert check mode reports change"
  ansible.builtin.assert:
    that:
      - srv_check_create.changed

- name: "Test 7.3: Verify SRV record was not actually created"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_ldap._tcp.srv-check.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: srv_check_verify
  ignore_errors: true

- name: "Test 7.4: Assert SRV record does not exist"
  ansible.builtin.assert:
    that:
      - srv_check_verify.failed or (srv_check_verify.records | selectattr('type', 'equalto', 'SRV') | list | length == 0)

- name: "Test 7.5: Create SRV record for real (for delete check mode test)"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_ldap._tcp.srv-check.{{ primary_zone_name }}"
    type: SRV
    priority: 0
    weight: 100
    srv_port: 389
    target: "ldap.example.com"
    state: present
  register: srv_real_create

- name: "Test 7.6: Delete SRV record in check mode"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_ldap._tcp.srv-check.{{ primary_zone_name }}"
    type: SRV
    state: absent
  check_mode: true
  register: srv_check_delete

- name: "Test 7.7: Assert check mode delete reports change"
  ansible.builtin.assert:
    that:
      - srv_check_delete.changed

- name: "Test 7.8: Verify SRV record still exists"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_ldap._tcp.srv-check.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: srv_check_delete_verify

- name: "Test 7.9: Assert SRV record still exists"
  ansible.builtin.assert:
    that:
      - srv_check_delete_verify.records | selectattr('type', 'equalto', 'SRV') | list | length == 1

# Test 8: TTL and comments
- name: "Test 8.1: Create SRV record with custom TTL and comments"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_xmpp-server._tcp.srv-metadata.{{ primary_zone_name }}"
    type: SRV
    priority: 5
    weight: 0
    srv_port: 5269
    target: "xmpp.example.com"
    ttl: 7200
    comments: "SRV record with custom TTL"
    state: present
  register: srv_metadata_result

- name: "Test 8.2: Assert SRV with metadata created"
  ansible.builtin.assert:
    that:
      - srv_metadata_result.changed

- name: "Test 8.3: Verify SRV metadata"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_xmpp-server._tcp.srv-metadata.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: srv_metadata_get

- name: "Test 8.4: Assert SRV metadata values"
  ansible.builtin.assert:
    that:
      - srv_metadata_get.records | selectattr('type', 'equalto', 'SRV') | list | length == 1
      - (srv_metadata_get.records | selectattr('type', 'equalto', 'SRV') | first).ttl == 7200
      - (srv_metadata_get.records | selectattr('type', 'equalto', 'SRV') | first).comments == "SRV record with custom TTL"

# Test 9: expiryTtl (auto-expiration)
- name: "Test 9.1: Create SRV record with expiryTtl for auto-deletion"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_temp._tcp.srv-expiry.{{ primary_zone_name }}"
    type: SRV
    priority: 10
    weight: 10
    srv_port: 9999
    target: "temp-service.example.com"
    expiryTtl: 300
    comments: "Temporary SRV - expires in 5 minutes"
    state: present
  register: srv_expiry_result

- name: "Test 9.2: Assert SRV with expiryTtl created"
  ansible.builtin.assert:
    that:
      - srv_expiry_result.changed

- name: "Test 9.3: Verify SRV expiryTtl"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_temp._tcp.srv-expiry.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: srv_expiry_get

- name: "Test 9.4: Assert SRV expiryTtl value"
  ansible.builtin.assert:
    that:
      - srv_expiry_get.records | selectattr('type', 'equalto', 'SRV') | list | length == 1
      - (srv_expiry_get.records | selectattr('type', 'equalto', 'SRV') | first).expiryTtl == 300

- name: "Test 9.5: Create SRV record in DNSSEC-enabled zone"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_sip._tcp.dnssec-test.{{ primary_sec_zone_name }}"
    zone: "{{ primary_sec_zone_name }}"
    type: SRV
    priority: 10
    weight: 5
    srv_port: 5060
    target: "sip.example.com"
    state: present
  register: test9_dnssec_create

- name: "Test 9.5: Assert DNSSEC zone record created"
  ansible.builtin.assert:
    that:
      - test9_dnssec_create is changed

- name: "Test 9.5: Cleanup DNSSEC zone test"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_sip._tcp.dnssec-test.{{ primary_sec_zone_name }}"
    zone: "{{ primary_sec_zone_name }}"
    type: SRV
    state: absent

# Test 10: Negative tests
- name: "Test 10.1: SRV without required priority should fail"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_test._tcp.srv-neg.{{ primary_zone_name }}"
    type: SRV
    weight: 10
    srv_port: 9000
    target: "test.example.com"
    state: present
  register: srv_no_priority
  ignore_errors: true

- name: "Test 10.2: Assert failure for missing priority"
  ansible.builtin.assert:
    that:
      - srv_no_priority.failed
      - "'priority' in (srv_no_priority.msg | default(''))"

- name: "Test 10.3: SRV with unsupported parameter should fail"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_test._tcp.srv-neg.{{ primary_zone_name }}"
    type: SRV
    priority: 10
    weight: 10
    srv_port: 9000
    target: "test.example.com"
    ipAddress: "192.0.2.99"
    state: present
  register: srv_bad_param
  ignore_errors: true

- name: "Test 10.4: Assert failure for unsupported parameter"
  ansible.builtin.assert:
    that:
      - srv_bad_param.failed
      - "'ipAddress' in (srv_bad_param.msg | default(''))"

- name: "Test 10.5: SRV with invalid API token should fail"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "INVALID_TOKEN"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_test._tcp.srv-neg.{{ primary_zone_name }}"
    type: SRV
    priority: 10
    weight: 10
    srv_port: 9000
    target: "test.example.com"
    state: present
  register: srv_bad_token
  ignore_errors: true

- name: "Test 10.6: Assert failure for invalid token"
  ansible.builtin.assert:
    that:
      - srv_bad_token.failed
      - "'Invalid token' in (srv_bad_token.msg | default(''))"

# Test 11: Delete non-existent record (idempotency)
- name: "Test 11.1: Delete non-existent SRV record"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_nonexist._tcp.srv-none.{{ primary_zone_name }}"
    type: SRV
    priority: 99
    weight: 99
    srv_port: 9999
    target: "nonexistent.example.com"
    state: absent
  register: srv_delete_nonexist

- name: "Test 11.2: Assert no change for deleting non-existent record"
  ansible.builtin.assert:
    that:
      - not srv_delete_nonexist.changed

# Cleanup: Delete test SRV records
- name: "Cleanup: Delete test SRV records"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "{{ item }}"
    type: SRV
    state: absent
  loop:
    - "_sip._tcp.srv-basic.{{ primary_zone_name }}"
    - "_ldap._tcp.srv-check.{{ primary_zone_name }}"
    - "_xmpp-server._tcp.srv-metadata.{{ primary_zone_name }}"
    - "_temp._tcp.srv-expiry.{{ primary_zone_name }}"
  ignore_errors: true
