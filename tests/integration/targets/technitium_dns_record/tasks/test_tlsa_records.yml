---
# TLSA record integration tests for state-based module
# TLSA records store TLS certificate association data for DANE

# Test 1: Basic TLSA record creation using shorthand
- name: "Test 1.1: Create basic TLSA record using shorthand"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-basic.{{ primary_zone_name }}"
    type: TLSA
    tlsaCertificateUsage: DANE-EE
    tlsaSelector: SPKI
    tlsaMatchingType: SHA2-256
    tlsaCertificateAssociationData: abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890
    state: present
  register: tlsa_basic_result

- name: "Test 1.2: Assert TLSA record was created"
  ansible.builtin.assert:
    that:
      - tlsa_basic_result.changed

- name: "Test 1.3: Verify TLSA record exists"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-basic.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: tlsa_basic_get

- name: "Test 1.4: Assert TLSA values match"
  ansible.builtin.assert:
    that:
      - tlsa_basic_get.records | selectattr('type', 'equalto', 'TLSA') | list | length == 1
      - (tlsa_basic_get.records | selectattr('type', 'equalto', 'TLSA') | first).rData.certificateUsage == "DANE-EE"
      - (tlsa_basic_get.records | selectattr('type', 'equalto', 'TLSA') | first).rData.selector == "SPKI"
      - (tlsa_basic_get.records | selectattr('type', 'equalto', 'TLSA') | first).rData.matchingType == "SHA2-256"
      - (tlsa_basic_get.records | selectattr('type', 'equalto', 'TLSA') | first).rData.certificateAssociationData | lower == "abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"

- name: "Test 1.5: Re-create TLSA record (idempotency)"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-basic.{{ primary_zone_name }}"
    type: TLSA
    records:
      - tlsaCertificateUsage: DANE-EE
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890
    overwrite: true
    state: present
  register: tlsa_basic_idempotent

- name: "Test 1.6: Assert idempotency (no change)"
  ansible.builtin.assert:
    that:
      - not tlsa_basic_idempotent.changed

# Test 2: Multiple TLSA records - all 24 enum combinations (4 usages × 2 selectors × 3 matching types)
- name: "Test 2.0: Set TLSA certificate association data samples"
  ansible.builtin.set_fact:
    tlsa_data_sha256: "abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
    tlsa_data_sha512: "abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
    tlsa_data_full: "abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"

- name: "Test 2.1: Create all 24 TLSA enum combinations using records list"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-multi.{{ primary_zone_name }}"
    type: TLSA
    records:
      # PKIX-TA combinations (6)
      - tlsaCertificateUsage: PKIX-TA
        tlsaSelector: Cert
        tlsaMatchingType: Full
        tlsaCertificateAssociationData: "{{ tlsa_data_full }}"
      - tlsaCertificateUsage: PKIX-TA
        tlsaSelector: Cert
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: "{{ tlsa_data_sha256 }}"
      - tlsaCertificateUsage: PKIX-TA
        tlsaSelector: Cert
        tlsaMatchingType: SHA2-512
        tlsaCertificateAssociationData: "{{ tlsa_data_sha512 }}"
      - tlsaCertificateUsage: PKIX-TA
        tlsaSelector: SPKI
        tlsaMatchingType: Full
        tlsaCertificateAssociationData: "{{ tlsa_data_full }}"
      - tlsaCertificateUsage: PKIX-TA
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: "{{ tlsa_data_sha256 }}"
      - tlsaCertificateUsage: PKIX-TA
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-512
        tlsaCertificateAssociationData: "{{ tlsa_data_sha512 }}"
      # PKIX-EE combinations (6)
      - tlsaCertificateUsage: PKIX-EE
        tlsaSelector: Cert
        tlsaMatchingType: Full
        tlsaCertificateAssociationData: "{{ tlsa_data_full }}"
      - tlsaCertificateUsage: PKIX-EE
        tlsaSelector: Cert
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: "{{ tlsa_data_sha256 }}"
      - tlsaCertificateUsage: PKIX-EE
        tlsaSelector: Cert
        tlsaMatchingType: SHA2-512
        tlsaCertificateAssociationData: "{{ tlsa_data_sha512 }}"
      - tlsaCertificateUsage: PKIX-EE
        tlsaSelector: SPKI
        tlsaMatchingType: Full
        tlsaCertificateAssociationData: "{{ tlsa_data_full }}"
      - tlsaCertificateUsage: PKIX-EE
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: "{{ tlsa_data_sha256 }}"
      - tlsaCertificateUsage: PKIX-EE
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-512
        tlsaCertificateAssociationData: "{{ tlsa_data_sha512 }}"
      # DANE-TA combinations (6)
      - tlsaCertificateUsage: DANE-TA
        tlsaSelector: Cert
        tlsaMatchingType: Full
        tlsaCertificateAssociationData: "{{ tlsa_data_full }}"
      - tlsaCertificateUsage: DANE-TA
        tlsaSelector: Cert
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: "{{ tlsa_data_sha256 }}"
      - tlsaCertificateUsage: DANE-TA
        tlsaSelector: Cert
        tlsaMatchingType: SHA2-512
        tlsaCertificateAssociationData: "{{ tlsa_data_sha512 }}"
      - tlsaCertificateUsage: DANE-TA
        tlsaSelector: SPKI
        tlsaMatchingType: Full
        tlsaCertificateAssociationData: "{{ tlsa_data_full }}"
      - tlsaCertificateUsage: DANE-TA
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: "{{ tlsa_data_sha256 }}"
      - tlsaCertificateUsage: DANE-TA
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-512
        tlsaCertificateAssociationData: "{{ tlsa_data_sha512 }}"
      # DANE-EE combinations (6)
      - tlsaCertificateUsage: DANE-EE
        tlsaSelector: Cert
        tlsaMatchingType: Full
        tlsaCertificateAssociationData: "{{ tlsa_data_full }}"
      - tlsaCertificateUsage: DANE-EE
        tlsaSelector: Cert
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: "{{ tlsa_data_sha256 }}"
      - tlsaCertificateUsage: DANE-EE
        tlsaSelector: Cert
        tlsaMatchingType: SHA2-512
        tlsaCertificateAssociationData: "{{ tlsa_data_sha512 }}"
      - tlsaCertificateUsage: DANE-EE
        tlsaSelector: SPKI
        tlsaMatchingType: Full
        tlsaCertificateAssociationData: "{{ tlsa_data_full }}"
      - tlsaCertificateUsage: DANE-EE
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: "{{ tlsa_data_sha256 }}"
      - tlsaCertificateUsage: DANE-EE
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-512
        tlsaCertificateAssociationData: "{{ tlsa_data_sha512 }}"
    state: present
  register: tlsa_multi_result

- name: "Test 2.2: Assert TLSA records created"
  ansible.builtin.assert:
    that:
      - tlsa_multi_result.changed

- name: "Test 2.3: Verify all 24 TLSA records exist"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-multi.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: tlsa_multi_get

- name: "Test 2.4: Assert all 24 TLSA enum combinations exist"
  ansible.builtin.assert:
    that:
      - tlsa_multi_get.records | selectattr('type', 'equalto', 'TLSA') | list | length == 24
      - tlsa_multi_get.records | selectattr('type', 'equalto', 'TLSA') | selectattr('rData.certificateUsage', 'equalto', 'PKIX-TA') | list | length == 6
      - tlsa_multi_get.records | selectattr('type', 'equalto', 'TLSA') | selectattr('rData.certificateUsage', 'equalto', 'PKIX-EE') | list | length == 6
      - tlsa_multi_get.records | selectattr('type', 'equalto', 'TLSA') | selectattr('rData.certificateUsage', 'equalto', 'DANE-TA') | list | length == 6
      - tlsa_multi_get.records | selectattr('type', 'equalto', 'TLSA') | selectattr('rData.certificateUsage', 'equalto', 'DANE-EE') | list | length == 6
      - tlsa_multi_get.records | selectattr('type', 'equalto', 'TLSA') | selectattr('rData.selector', 'equalto', 'Cert') | list | length == 12
      - tlsa_multi_get.records | selectattr('type', 'equalto', 'TLSA') | selectattr('rData.selector', 'equalto', 'SPKI') | list | length == 12

- name: "Test 2.5: Re-create all 24 TLSA records (idempotency)"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-multi.{{ primary_zone_name }}"
    type: TLSA
    records:
      # PKIX-TA + Cert combinations (3)
      - tlsaCertificateUsage: PKIX-TA
        tlsaSelector: Cert
        tlsaMatchingType: Full
        tlsaCertificateAssociationData: "{{ tlsa_data_full }}"
      - tlsaCertificateUsage: PKIX-TA
        tlsaSelector: Cert
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: "{{ tlsa_data_sha256 }}"
      - tlsaCertificateUsage: PKIX-TA
        tlsaSelector: Cert
        tlsaMatchingType: SHA2-512
        tlsaCertificateAssociationData: "{{ tlsa_data_sha512 }}"
      # PKIX-TA + SPKI combinations (3)
      - tlsaCertificateUsage: PKIX-TA
        tlsaSelector: SPKI
        tlsaMatchingType: Full
        tlsaCertificateAssociationData: "{{ tlsa_data_full }}"
      - tlsaCertificateUsage: PKIX-TA
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: "{{ tlsa_data_sha256 }}"
      - tlsaCertificateUsage: PKIX-TA
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-512
        tlsaCertificateAssociationData: "{{ tlsa_data_sha512 }}"
      # PKIX-EE + Cert combinations (3)
      - tlsaCertificateUsage: PKIX-EE
        tlsaSelector: Cert
        tlsaMatchingType: Full
        tlsaCertificateAssociationData: "{{ tlsa_data_full }}"
      - tlsaCertificateUsage: PKIX-EE
        tlsaSelector: Cert
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: "{{ tlsa_data_sha256 }}"
      - tlsaCertificateUsage: PKIX-EE
        tlsaSelector: Cert
        tlsaMatchingType: SHA2-512
        tlsaCertificateAssociationData: "{{ tlsa_data_sha512 }}"
      # PKIX-EE + SPKI combinations (3)
      - tlsaCertificateUsage: PKIX-EE
        tlsaSelector: SPKI
        tlsaMatchingType: Full
        tlsaCertificateAssociationData: "{{ tlsa_data_full }}"
      - tlsaCertificateUsage: PKIX-EE
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: "{{ tlsa_data_sha256 }}"
      - tlsaCertificateUsage: PKIX-EE
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-512
        tlsaCertificateAssociationData: "{{ tlsa_data_sha512 }}"
      # DANE-TA + Cert combinations (3)
      - tlsaCertificateUsage: DANE-TA
        tlsaSelector: Cert
        tlsaMatchingType: Full
        tlsaCertificateAssociationData: "{{ tlsa_data_full }}"
      - tlsaCertificateUsage: DANE-TA
        tlsaSelector: Cert
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: "{{ tlsa_data_sha256 }}"
      - tlsaCertificateUsage: DANE-TA
        tlsaSelector: Cert
        tlsaMatchingType: SHA2-512
        tlsaCertificateAssociationData: "{{ tlsa_data_sha512 }}"
      # DANE-TA + SPKI combinations (3)
      - tlsaCertificateUsage: DANE-TA
        tlsaSelector: SPKI
        tlsaMatchingType: Full
        tlsaCertificateAssociationData: "{{ tlsa_data_full }}"
      - tlsaCertificateUsage: DANE-TA
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: "{{ tlsa_data_sha256 }}"
      - tlsaCertificateUsage: DANE-TA
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-512
        tlsaCertificateAssociationData: "{{ tlsa_data_sha512 }}"
      # DANE-EE + Cert combinations (3)
      - tlsaCertificateUsage: DANE-EE
        tlsaSelector: Cert
        tlsaMatchingType: Full
        tlsaCertificateAssociationData: "{{ tlsa_data_full }}"
      - tlsaCertificateUsage: DANE-EE
        tlsaSelector: Cert
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: "{{ tlsa_data_sha256 }}"
      - tlsaCertificateUsage: DANE-EE
        tlsaSelector: Cert
        tlsaMatchingType: SHA2-512
        tlsaCertificateAssociationData: "{{ tlsa_data_sha512 }}"
      # DANE-EE + SPKI combinations (3)
      - tlsaCertificateUsage: DANE-EE
        tlsaSelector: SPKI
        tlsaMatchingType: Full
        tlsaCertificateAssociationData: "{{ tlsa_data_full }}"
      - tlsaCertificateUsage: DANE-EE
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: "{{ tlsa_data_sha256 }}"
      - tlsaCertificateUsage: DANE-EE
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-512
        tlsaCertificateAssociationData: "{{ tlsa_data_sha512 }}"
    state: present
  register: tlsa_multi_idempotent

- name: "Test 2.6: Assert idempotency (no change)"
  ansible.builtin.assert:
    that:
      - not tlsa_multi_idempotent.changed

# Test 3: Overwrite mode
- name: "Test 3.1: Overwrite TLSA records with new set"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-multi.{{ primary_zone_name }}"
    type: TLSA
    records:
      - tlsaCertificateUsage: PKIX-EE
        tlsaSelector: SPKI
        tlsaMatchingType: SHA2-256
        tlsaCertificateAssociationData: 4444444444444444444444444444444444444444444444444444444444444444
    overwrite: true
    state: present
  register: tlsa_overwrite_result

- name: "Test 3.2: Assert overwrite changed"
  ansible.builtin.assert:
    that:
      - tlsa_overwrite_result.changed

- name: "Test 3.3: Verify only new TLSA record exists"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-multi.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: tlsa_overwrite_get

- name: "Test 3.4: Assert old TLSA records removed, new one exists"
  ansible.builtin.assert:
    that:
      - tlsa_overwrite_get.records | selectattr('type', 'equalto', 'TLSA') | list | length == 1
      - tlsa_overwrite_get.records | selectattr('type', 'equalto', 'TLSA') | selectattr('rData.certificateUsage', 'equalto', 'PKIX-EE') | list | length == 1
      - (tlsa_overwrite_get.records | selectattr('type', 'equalto', 'TLSA') | first).rData.certificateAssociationData | lower == "4444444444444444444444444444444444444444444444444444444444444444"

# Test 4: Additive mode (overwrite: false)
- name: "Test 4.1: Add TLSA record to existing set (additive)"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-multi.{{ primary_zone_name }}"
    type: TLSA
    tlsaCertificateUsage: DANE-TA
    tlsaSelector: SPKI
    tlsaMatchingType: SHA2-256
    tlsaCertificateAssociationData: 5555555555555555555555555555555555555555555555555555555555555555
    overwrite: false
    state: present
  register: tlsa_additive_result

- name: "Test 4.2: Assert additive mode changed"
  ansible.builtin.assert:
    that:
      - tlsa_additive_result.changed

- name: "Test 4.3: Verify all TLSA records exist (old + new)"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-multi.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: tlsa_additive_get

- name: "Test 4.4: Assert all TLSA records present"
  ansible.builtin.assert:
    that:
      - tlsa_additive_get.records | selectattr('type', 'equalto', 'TLSA') | list | length == 2
      - tlsa_additive_get.records | selectattr('type', 'equalto', 'TLSA') | map(attribute='rData.certificateAssociationData') | map('lower') | select('search', '^444444') | list | length == 1
      - tlsa_additive_get.records | selectattr('type', 'equalto', 'TLSA') | map(attribute='rData.certificateAssociationData') | map('lower') | select('search', '^555555') | list | length == 1

# Test 5: Selective deletion by identifying fields
- name: "Test 5.1: Delete specific TLSA record by identifying fields"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-multi.{{ primary_zone_name }}"
    type: TLSA
    tlsaCertificateUsage: DANE-TA
    tlsaSelector: SPKI
    tlsaMatchingType: SHA2-256
    tlsaCertificateAssociationData: 5555555555555555555555555555555555555555555555555555555555555555
    state: absent
  register: tlsa_delete_specific_result

- name: "Test 5.2: Assert specific TLSA deleted"
  ansible.builtin.assert:
    that:
      - tlsa_delete_specific_result.changed

- name: "Test 5.3: Verify specific TLSA record removed"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-multi.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: tlsa_delete_specific_get

- name: "Test 5.4: Assert only DANE-TA TLSA removed, PKIX-EE remains"
  ansible.builtin.assert:
    that:
      - tlsa_delete_specific_get.records | selectattr('type', 'equalto', 'TLSA') | list | length == 1
      - tlsa_delete_specific_get.records | selectattr('type', 'equalto', 'TLSA') | map(attribute='rData.certificateAssociationData') | map('lower') | select('search', '^444444') | list | length == 1
      - tlsa_delete_specific_get.records | selectattr('type', 'equalto', 'TLSA') | map(attribute='rData.certificateAssociationData') | map('lower') | select('search', '^555555') | list | length == 0

# Test 6: Delete all TLSA records by name/type
- name: "Test 6.1: Delete all TLSA records for name"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-multi.{{ primary_zone_name }}"
    type: TLSA
    state: absent
  register: tlsa_delete_all_result

- name: "Test 6.2: Assert all TLSA records deleted"
  ansible.builtin.assert:
    that:
      - tlsa_delete_all_result.changed

- name: "Test 6.3: Verify no TLSA records remain"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-multi.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: tlsa_delete_all_get
  ignore_errors: true

- name: "Test 6.4: Assert no TLSA records found"
  ansible.builtin.assert:
    that:
      - tlsa_delete_all_get.failed or (tlsa_delete_all_get.records | selectattr('type', 'equalto', 'TLSA') | list | length == 0)

# Test 7: Check mode
- name: "Test 7.1: Create TLSA record in check mode"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-check.{{ primary_zone_name }}"
    type: TLSA
    tlsaCertificateUsage: DANE-EE
    tlsaSelector: SPKI
    tlsaMatchingType: SHA2-256
    tlsaCertificateAssociationData: 6666666666666666666666666666666666666666666666666666666666666666
    state: present
  check_mode: true
  register: tlsa_check_create

- name: "Test 7.2: Assert check mode reports change"
  ansible.builtin.assert:
    that:
      - tlsa_check_create.changed

- name: "Test 7.3: Verify TLSA record was not actually created"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-check.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: tlsa_check_verify
  ignore_errors: true

- name: "Test 7.4: Assert TLSA record does not exist"
  ansible.builtin.assert:
    that:
      - tlsa_check_verify.failed or (tlsa_check_verify.records | selectattr('type', 'equalto', 'TLSA') | list | length == 0)

- name: "Test 7.5: Create TLSA record for real (for delete check mode test)"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-check.{{ primary_zone_name }}"
    type: TLSA
    tlsaCertificateUsage: DANE-EE
    tlsaSelector: SPKI
    tlsaMatchingType: SHA2-256
    tlsaCertificateAssociationData: 6666666666666666666666666666666666666666666666666666666666666666
    state: present

- name: "Test 7.6: Delete TLSA record in check mode"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-check.{{ primary_zone_name }}"
    type: TLSA
    state: absent
  check_mode: true
  register: tlsa_check_delete

- name: "Test 7.7: Assert check mode delete reports change"
  ansible.builtin.assert:
    that:
      - tlsa_check_delete.changed

- name: "Test 7.8: Verify TLSA record still exists"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-check.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: tlsa_check_still_exists

- name: "Test 7.9: Assert TLSA record still exists"
  ansible.builtin.assert:
    that:
      - tlsa_check_still_exists.records | selectattr('type', 'equalto', 'TLSA') | list | length == 1

# Test 8: Custom TTL and comments
- name: "Test 8.1: Create TLSA record with custom TTL and comments"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-metadata.{{ primary_zone_name }}"
    type: TLSA
    tlsaCertificateUsage: DANE-EE
    tlsaSelector: SPKI
    tlsaMatchingType: SHA2-256
    tlsaCertificateAssociationData: 7777777777777777777777777777777777777777777777777777777777777777
    ttl: 7200
    comments: "Production TLS certificate fingerprint"
    state: present
  register: tlsa_metadata_result

- name: "Test 8.2: Assert TLSA with metadata created"
  ansible.builtin.assert:
    that:
      - tlsa_metadata_result.changed

- name: "Test 8.3: Verify TLSA metadata"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-metadata.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: tlsa_metadata_get

- name: "Test 8.4: Assert TLSA metadata values"
  ansible.builtin.assert:
    that:
      - tlsa_metadata_get.records | selectattr('type', 'equalto', 'TLSA') | list | length == 1
      - (tlsa_metadata_get.records | selectattr('type', 'equalto', 'TLSA') | first).ttl == 7200
      - (tlsa_metadata_get.records | selectattr('type', 'equalto', 'TLSA') | first).comments == "Production TLS certificate fingerprint"

# Test 9: ExpiryTtl for auto-deletion
- name: "Test 9.1: Create TLSA record with expiryTtl for auto-deletion"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-temp.{{ primary_zone_name }}"
    type: TLSA
    tlsaCertificateUsage: DANE-EE
    tlsaSelector: SPKI
    tlsaMatchingType: SHA2-256
    tlsaCertificateAssociationData: 8888888888888888888888888888888888888888888888888888888888888888
    expiryTtl: 86400
    state: present
  register: tlsa_expiry_result

- name: "Test 9.2: Assert TLSA with expiryTtl created"
  ansible.builtin.assert:
    that:
      - tlsa_expiry_result.changed

- name: "Test 9.3: Verify TLSA expiryTtl"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-temp.{{ primary_zone_name }}"
    zone: "{{ primary_zone_name }}"
  register: tlsa_expiry_get

- name: "Test 9.4: Assert TLSA expiryTtl value"
  ansible.builtin.assert:
    that:
      - tlsa_expiry_get.records | selectattr('type', 'equalto', 'TLSA') | list | length == 1
      - (tlsa_expiry_get.records | selectattr('type', 'equalto', 'TLSA') | first).expiryTtl == 86400

- name: "Test 9.5: Create TLSA record in DNSSEC-enabled zone"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.dnssec-test.{{ primary_sec_zone_name }}"
    zone: "{{ primary_sec_zone_name }}"
    type: TLSA
    tlsaCertificateUsage: PKIX-TA
    tlsaSelector: Cert
    tlsaMatchingType: Full
    tlsaCertificateAssociationData: "{{ tlsa_data_full }}"
    state: present
  register: test9_dnssec_create

- name: "Test 9.5: Assert DNSSEC zone record created"
  ansible.builtin.assert:
    that:
      - test9_dnssec_create is changed

- name: "Test 9.5: Cleanup DNSSEC zone test"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.dnssec-test.{{ primary_sec_zone_name }}"
    zone: "{{ primary_sec_zone_name }}"
    type: TLSA
    state: absent

# Test 10: Negative tests - error conditions
- name: "Test 10.1: TLSA without required tlsaCertificateUsage should fail"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-invalid.{{ primary_zone_name }}"
    type: TLSA
    tlsaSelector: SPKI
    tlsaMatchingType: SHA2-256
    tlsaCertificateAssociationData: 9999999999999999999999999999999999999999999999999999999999999999
    state: present
  register: tlsa_missing_usage
  ignore_errors: true

- name: "Test 10.2: Assert failure for missing tlsaCertificateUsage"
  ansible.builtin.assert:
    that:
      - tlsa_missing_usage.failed

- name: "Test 10.3: TLSA with unsupported parameter should fail"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-invalid.{{ primary_zone_name }}"
    type: TLSA
    tlsaCertificateUsage: DANE-EE
    tlsaSelector: SPKI
    tlsaMatchingType: SHA2-256
    tlsaCertificateAssociationData: 9999999999999999999999999999999999999999999999999999999999999999
    ipAddress: "192.0.2.1"
    state: present
  register: tlsa_invalid_param
  ignore_errors: true

- name: "Test 10.4: Assert failure for unsupported parameter"
  ansible.builtin.assert:
    that:
      - tlsa_invalid_param.failed

- name: "Test 10.5: TLSA with invalid API token should fail"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "invalid-token-12345"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-invalid.{{ primary_zone_name }}"
    type: TLSA
    tlsaCertificateUsage: DANE-EE
    tlsaSelector: SPKI
    tlsaMatchingType: SHA2-256
    tlsaCertificateAssociationData: 9999999999999999999999999999999999999999999999999999999999999999
    state: present
  register: tlsa_invalid_token
  ignore_errors: true

- name: "Test 10.6: Assert failure for invalid token"
  ansible.builtin.assert:
    that:
      - tlsa_invalid_token.failed

# Test 11: Deleting non-existent record is idempotent
- name: "Test 11.1: Delete non-existent TLSA record"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "_443._tcp.tlsa-nonexistent.{{ primary_zone_name }}"
    type: TLSA
    state: absent
  register: tlsa_delete_nonexistent

- name: "Test 11.2: Assert no change for deleting non-existent record"
  ansible.builtin.assert:
    that:
      - not tlsa_delete_nonexistent.changed

# Cleanup: Delete test TLSA records
- name: "Cleanup: Delete test TLSA records"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "{{ item }}"
    type: TLSA
    state: absent
  loop:
    - "_443._tcp.tlsa-basic.{{ primary_zone_name }}"
    - "_443._tcp.tlsa-check.{{ primary_zone_name }}"
    - "_443._tcp.tlsa-metadata.{{ primary_zone_name }}"
    - "_443._tcp.tlsa-temp.{{ primary_zone_name }}"
  ignore_errors: true
