---
# FWD (Forwarder) Record Tests for technitium_dns_record module
# NOTE: FWD records support multiple records per DNS name
# FWD records are conditional forwarders used in Forwarder zones

# =============================================================================
# Test 1: Shorthand Single Record - Create, Update, Delete
# =============================================================================
- name: "Test 1.1: Create single FWD record using shorthand syntax"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "shorthand-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    protocol: "Udp"
    forwarder: "192.0.2.10"
    forwarderPriority: 10
    state: present
  register: test1_create

- name: "Test 1.1: Assert record was created"
  ansible.builtin.assert:
    that:
      - test1_create is changed

- name: "Test 1.2: Verify record exists with correct values"
  technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "shorthand-fwd.{{ forwarder_zone_name }}"
  register: test1_verify

- name: "Test 1.2: Assert record values"
  ansible.builtin.assert:
    that:
      - test1_verify.records | length == 1
      - test1_verify.records[0].type == 'FWD'
      - test1_verify.records[0].rData.protocol == 'Udp'
      - test1_verify.records[0].rData.forwarder == '192.0.2.10'
      - test1_verify.records[0].rData.priority == 10

- name: "Test 1.3: Idempotency - Run same create again"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "shorthand-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    protocol: "Udp"
    forwarder: "192.0.2.10"
    forwarderPriority: 10
    state: present
  register: test1_idempotent

- name: "Test 1.3: Assert no changes"
  ansible.builtin.assert:
    that:
      - test1_idempotent is not changed

- name: "Test 1.4: Delete record using shorthand"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "shorthand-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    state: absent
  register: test1_delete

- name: "Test 1.4: Assert deletion succeeded"
  ansible.builtin.assert:
    that:
      - test1_delete is changed

- name: "Test 1.5: Verify record was deleted"
  technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "shorthand-fwd.{{ forwarder_zone_name }}"
  register: test1_verify_delete
  ignore_errors: true

- name: "Test 1.5: Assert record is gone"
  ansible.builtin.assert:
    that:
      - test1_verify_delete is failed

# =============================================================================
# Test 2: Multiple Records in a Set - Different Forwarders
# =============================================================================
- name: "Test 2.1: Create multiple FWD records"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "multi-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    ttl: 7200
    records:
      - protocol: "Udp"
        forwarder: "192.0.2.20"
        forwarderPriority: 10
      - protocol: "Tcp"
        forwarder: "192.0.2.20"
        forwarderPriority: 20
      - protocol: "Udp"
        forwarder: "2001:db8::30"
        forwarderPriority: 5
    state: present
  register: test2_create

- name: "Test 2.1: Assert records were created"
  ansible.builtin.assert:
    that:
      - test2_create is changed

- name: "Test 2.2: Verify all 3 records exist"
  technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "multi-fwd.{{ forwarder_zone_name }}"
  register: test2_verify

- name: "Test 2.2: Assert 3 FWD records exist"
  ansible.builtin.assert:
    that:
      - test2_verify.records | length == 3
      - test2_verify.records | selectattr('rData.protocol', 'equalto', 'Udp') | list | length == 2
      - test2_verify.records | selectattr('rData.protocol', 'equalto', 'Tcp') | list | length == 1

- name: "Test 2.3: Idempotency - Run same create again"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "multi-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    ttl: 7200
    records:
      - protocol: "Udp"
        forwarder: "192.0.2.20"
        forwarderPriority: 10
      - protocol: "Tcp"
        forwarder: "192.0.2.20"
        forwarderPriority: 20
      - protocol: "Udp"
        forwarder: "2001:db8::30"
        forwarderPriority: 5
    state: present
  register: test2_idempotent

- name: "Test 2.3: Assert no changes"
  ansible.builtin.assert:
    that:
      - test2_idempotent is not changed

- name: "Test 2.4: Delete entire record set"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "multi-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    state: absent
  register: test2_delete

- name: "Test 2.4: Assert deletion succeeded"
  ansible.builtin.assert:
    that:
      - test2_delete is changed

# =============================================================================
# Test 3: Overwrite Mode - Replace Entire Set
# =============================================================================
- name: "Test 3.1: Create initial set of FWD records"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "overwrite-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    ttl: 3600
    records:
      - protocol: "Udp"
        forwarder: "192.0.2.100"
        forwarderPriority: 10
      - protocol: "Tcp"
        forwarder: "192.0.2.100"
        forwarderPriority: 20
    state: present
  register: test3_create

- name: "Test 3.1: Assert initial records were created"
  ansible.builtin.assert:
    that:
      - test3_create is changed

- name: "Test 3.2: Overwrite with completely different set (overwrite=true)"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "overwrite-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    ttl: 7200
    overwrite: true
    records:
      - protocol: "Udp"
        forwarder: "203.0.113.50"
        forwarderPriority: 5
    state: present
  register: test3_overwrite

- name: "Test 3.2: Assert overwrite was applied"
  ansible.builtin.assert:
    that:
      - test3_overwrite is changed

- name: "Test 3.3: Verify only new records exist"
  technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "overwrite-fwd.{{ forwarder_zone_name }}"
  register: test3_verify

- name: "Test 3.3: Assert only replacement records exist"
  ansible.builtin.assert:
    that:
      - test3_verify.records | length == 1
      - test3_verify.records[0].rData.forwarder == '203.0.113.50'
      - test3_verify.records | selectattr('rData.forwarder', 'equalto', '192.0.2.100') | list | length == 0

- name: "Test 3.4: Delete overwrite test records"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "overwrite-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    state: absent
  register: test3_delete

# =============================================================================
# Test 4: Additive Mode - Merge with Existing Records
# =============================================================================
- name: "Test 4.1: Create initial set of FWD records"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "additive-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    ttl: 3600
    records:
      - protocol: "Udp"
        forwarder: "192.0.2.110"
        forwarderPriority: 10
    state: present
  register: test4_create

- name: "Test 4.1: Assert initial records were created"
  ansible.builtin.assert:
    that:
      - test4_create is changed

- name: "Test 4.2: Add new records with overwrite=false (additive)"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "additive-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    ttl: 3600
    overwrite: false
    records:
      - protocol: "Tcp"
        forwarder: "192.0.2.110"
        forwarderPriority: 20
    state: present
  register: test4_add

- name: "Test 4.2: Assert new records were added"
  ansible.builtin.assert:
    that:
      - test4_add is changed

- name: "Test 4.3: Verify all records present (old + new)"
  technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "additive-fwd.{{ forwarder_zone_name }}"
  register: test4_verify

- name: "Test 4.3: Assert 2 total records (1 old + 1 new)"
  ansible.builtin.assert:
    that:
      - test4_verify.records | length == 2
      - test4_verify.records | selectattr('rData.protocol', 'equalto', 'Udp') | list | length == 1
      - test4_verify.records | selectattr('rData.protocol', 'equalto', 'Tcp') | list | length == 1

- name: "Test 4.4: Delete additive test records"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "additive-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    state: absent
  register: test4_delete

# =============================================================================
# Test 5: Selective Deletion - Delete Specific Records from Set
# =============================================================================
- name: "Test 5.1: Create set of 3 FWD records"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "selective-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    ttl: 3600
    records:
      - protocol: "Udp"
        forwarder: "192.0.2.120"
        forwarderPriority: 10
      - protocol: "Tcp"
        forwarder: "192.0.2.120"
        forwarderPriority: 20
      - protocol: "Udp"
        forwarder: "2001:db8::120"
        forwarderPriority: 30
    state: present
  register: test5_create

- name: "Test 5.2: Delete specific record (Tcp protocol)"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "selective-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    records:
      - protocol: "Tcp"
        forwarder: "192.0.2.120"
        forwarderPriority: 20
    state: absent
  register: test5_delete_specific

- name: "Test 5.2: Assert specific record was deleted"
  ansible.builtin.assert:
    that:
      - test5_delete_specific is changed

- name: "Test 5.3: Verify only specified record deleted"
  technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "selective-fwd.{{ forwarder_zone_name }}"
  register: test5_verify

- name: "Test 5.3: Assert only 2 records remain"
  ansible.builtin.assert:
    that:
      - test5_verify.records | length == 2
      - test5_verify.records | selectattr('rData.protocol', 'equalto', 'Udp') | list | length == 2
      - test5_verify.records | selectattr('rData.protocol', 'equalto', 'Tcp') | list | length == 0

- name: "Test 5.4: Delete remaining records"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "selective-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    state: absent
  register: test5_delete_all

# =============================================================================
# Test 6: Check Mode
# =============================================================================
- name: "Test 6.1: Check mode - Create"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "check-mode-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    protocol: "Udp"
    forwarder: "192.0.2.130"
    forwarderPriority: 10
    ttl: 3600
    state: present
  check_mode: true
  register: test6_check

- name: "Test 6.1: Assert check mode reports change"
  ansible.builtin.assert:
    that:
      - test6_check is changed

- name: "Test 6.2: Verify record was not created"
  technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "check-mode-fwd.{{ forwarder_zone_name }}"
  register: test6_verify
  ignore_errors: true

- name: "Test 6.2: Assert record doesn't exist"
  ansible.builtin.assert:
    that:
      - test6_verify is failed

# =============================================================================
# Test 7: FWD with Optional Fields - DNSSEC and Proxy
# =============================================================================
- name: "Test 7.1: Create FWD with DNSSEC validation"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "dnssec-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    protocol: "Udp"
    forwarder: "192.0.2.140"
    forwarderPriority: 10
    dnssecValidation: true
    ttl: 3600
    comments: "DNSSEC validating forwarder"
    state: present
  register: test7_dnssec

- name: "Test 7.1: Assert DNSSEC FWD was created"
  ansible.builtin.assert:
    that:
      - test7_dnssec is changed

- name: "Test 7.2: Verify DNSSEC validation is enabled"
  technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "dnssec-fwd.{{ forwarder_zone_name }}"
  register: test7_verify

- name: "Test 7.2: Assert DNSSEC validation is true"
  ansible.builtin.assert:
    that:
      - test7_verify.records[0].rData.dnssecValidation == true

- name: "Test 7.3: Create FWD with proxy configuration"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "proxy-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    protocol: "Udp"
    forwarder: "2001:db8::150"
    forwarderPriority: 20
    proxyType: "Http"
    proxyAddress: "proxy.example.com"
    proxyPort: 8080
    proxyUsername: "testuser"
    proxyPassword: "testpass"
    ttl: 3600
    comments: "Proxy-enabled forwarder"
    state: present
  register: test7_proxy

- name: "Test 7.3: Assert proxy FWD was created"
  ansible.builtin.assert:
    that:
      - test7_proxy is changed

- name: "Test 7.4: Verify proxy configuration"
  technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "proxy-fwd.{{ forwarder_zone_name }}"
  register: test7_proxy_verify

- name: "Test 7.4: Assert proxy settings are correct"
  ansible.builtin.assert:
    that:
      - test7_proxy_verify.records[0].rData.proxyType == 'Http'
      - test7_proxy_verify.records[0].rData.proxyAddress == 'proxy.example.com'
      - test7_proxy_verify.records[0].rData.proxyPort == 8080

- name: "Test 7.5: Cleanup optional fields test records"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "{{ item }}.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    state: absent
  loop:
    - dnssec-fwd
    - proxy-fwd

# =============================================================================
# Test 8: Negative Tests - Missing Parameters
# =============================================================================
- name: "Test 8.1: Missing forwarder with shorthand (state=present)"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "missing-forwarder.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    protocol: "Udp"
    ttl: 3600
    state: present
  register: test8_missing_forwarder
  ignore_errors: true

- name: "Test 8.1: Assert missing parameter error"
  ansible.builtin.assert:
    that:
      - test8_missing_forwarder is failed
      - test8_missing_forwarder.msg is search("No records specified|forwarder")

- name: "Test 8.2: Missing required field in records list"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "missing-field.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    records:
      - protocol: "Udp"
        forwarderPriority: 10
    state: present
  register: test8_missing_field
  ignore_errors: true

- name: "Test 8.2: Assert missing field error"
  ansible.builtin.assert:
    that:
      - test8_missing_field is failed
      - test8_missing_field.msg is search("missing required field.*forwarder")

# =============================================================================
# Test 9: Negative Tests - Unsupported Parameters
# =============================================================================
- name: "Test 9.1: Unsupported parameter for FWD record (cname)"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "bad-param.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    protocol: "Udp"
    forwarder: "192.0.2.160"
    cname: "invalid.example.com"
    state: present
  register: test9_bad_param
  ignore_errors: true

- name: "Test 9.1: Assert unsupported parameter error"
  ansible.builtin.assert:
    that:
      - test9_bad_param is failed
      - test9_bad_param.msg is search("not supported")

- name: "Test 9.2: Unsupported parameter in records list"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "bad-param2.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    records:
      - protocol: "Udp"
        forwarder: "192.0.2.170"
        ipAddress: "192.0.2.999"
    state: present
  register: test9_bad_field
  ignore_errors: true

- name: "Test 9.2: Assert unsupported field error"
  ansible.builtin.assert:
    that:
      - test9_bad_field is failed
      - test9_bad_field.msg is search("contains unsupported field")

# =============================================================================
# Test 10: Negative Tests - Delete Operations
# =============================================================================
- name: "Test 10.1: Delete non-existent FWD record (idempotent)"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "nonexistent-fwd.{{ forwarder_zone_name }}"
    zone: "{{ forwarder_zone_name }}"
    type: FWD
    state: absent
  register: test10_delete_nonexistent

- name: "Test 10.1: Assert no changes"
  ansible.builtin.assert:
    that:
      - test10_delete_nonexistent is not changed

- name: "Test Completion Message"
  ansible.builtin.debug:
    msg: "FWD Record tests completed successfully!"
