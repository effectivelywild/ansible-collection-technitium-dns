---
# MX Record Integration Tests
# Tests the technitium_dns_record module's handling of MX (Mail Exchange) records
# MX records specify mail servers for a domain and their priority

# Test 1: Basic MX record using shorthand
- name: "Test 1.1: Create MX record using shorthand syntax"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "mail-test.{{ primary_zone_name }}"
    type: MX
    exchange: "mail1.{{ primary_zone_name }}"
    preference: 10
    state: present
  register: mx_shorthand_result

- name: "Test 1.2: Assert MX record was created"
  ansible.builtin.assert:
    that:
      - mx_shorthand_result is changed

- name: "Test 1.3: Verify MX record exists via get_record"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "mail-test.{{ primary_zone_name }}"
  register: mx_get_result

- name: "Test 1.4: Assert MX record data is correct"
  ansible.builtin.assert:
    that:
      - mx_get_result.records | selectattr('type', 'equalto', 'MX') | list | length == 1
      - (mx_get_result.records | selectattr('type', 'equalto', 'MX') | list | first).rData.exchange == "mail1." ~ primary_zone_name
      - (mx_get_result.records | selectattr('type', 'equalto', 'MX') | list | first).rData.preference == 10

- name: "Test 1.5: Verify idempotency - no change on re-run"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "mail-test.{{ primary_zone_name }}"
    type: MX
    exchange: "mail1.{{ primary_zone_name }}"
    preference: 10
    state: present
  register: mx_shorthand_idem_result

- name: "Test 1.6: Assert no change on idempotency check"
  ansible.builtin.assert:
    that:
      - mx_shorthand_idem_result is not changed

# Test 2: Multiple MX records with different priorities
- name: "Test 2.1: Add multiple MX records with records list"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "multi-mx.{{ primary_zone_name }}"
    type: MX
    records:
      - exchange: "mail1.{{ primary_zone_name }}"
        preference: 10
      - exchange: "mail2.{{ primary_zone_name }}"
        preference: 20
      - exchange: "mail3.{{ primary_zone_name }}"
        preference: 30
    state: present
  register: mx_multi_result

- name: "Test 2.2: Assert multiple MX records were created"
  ansible.builtin.assert:
    that:
      - mx_multi_result is changed

- name: "Test 2.3: Verify all three MX records exist"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "multi-mx.{{ primary_zone_name }}"
  register: mx_multi_get_result

- name: "Test 2.4: Assert all MX records have correct data"
  ansible.builtin.assert:
    that:
      - mx_multi_get_result.records | selectattr('type', 'equalto', 'MX') | list | length == 3
      - mx_multi_get_result.records | selectattr('type', 'equalto', 'MX') | selectattr('rData.preference', 'equalto', 10) | list | length == 1
      - mx_multi_get_result.records | selectattr('type', 'equalto', 'MX') | selectattr('rData.preference', 'equalto', 20) | list | length == 1
      - mx_multi_get_result.records | selectattr('type', 'equalto', 'MX') | selectattr('rData.preference', 'equalto', 30) | list | length == 1

# Test 3: Overwrite mode - replace all MX records
- name: "Test 3.1: Overwrite all MX records with new set"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "multi-mx.{{ primary_zone_name }}"
    type: MX
    overwrite: true
    records:
      - exchange: "mail99.{{ primary_zone_name }}"
        preference: 5
    state: present
  register: mx_overwrite_result

- name: "Test 3.2: Assert overwrite operation succeeded"
  ansible.builtin.assert:
    that:
      - mx_overwrite_result is changed

- name: "Test 3.3: Verify only the new MX record exists"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "multi-mx.{{ primary_zone_name }}"
  register: mx_overwrite_get_result

- name: "Test 3.4: Assert only one MX record with preference 5"
  ansible.builtin.assert:
    that:
      - mx_overwrite_get_result.records | selectattr('type', 'equalto', 'MX') | list | length == 1
      - (mx_overwrite_get_result.records | selectattr('type', 'equalto', 'MX') | list | first).rData.preference == 5
      - (mx_overwrite_get_result.records | selectattr('type', 'equalto', 'MX') | list | first).rData.exchange == "mail99." ~ primary_zone_name

# Test 4: Additive mode (overwrite=false) - add to existing records
- name: "Test 4.1: Add additional MX record in additive mode"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "multi-mx.{{ primary_zone_name }}"
    type: MX
    exchange: "mail-backup.{{ primary_zone_name }}"
    preference: 50
    overwrite: false
    state: present
  register: mx_additive_result

- name: "Test 4.2: Assert additive operation succeeded"
  ansible.builtin.assert:
    that:
      - mx_additive_result is changed

- name: "Test 4.3: Verify both MX records exist"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "multi-mx.{{ primary_zone_name }}"
  register: mx_additive_get_result

- name: "Test 4.4: Assert both MX records present"
  ansible.builtin.assert:
    that:
      - mx_additive_get_result.records | selectattr('type', 'equalto', 'MX') | list | length == 2
      - mx_additive_get_result.records | selectattr('type', 'equalto', 'MX') | selectattr('rData.preference', 'equalto', 5) | list | length == 1
      - mx_additive_get_result.records | selectattr('type', 'equalto', 'MX') | selectattr('rData.preference', 'equalto', 50) | list | length == 1

# Test 5: Selective deletion - delete specific MX record by identifying fields
- name: "Test 5.1: Delete specific MX record by exchange and preference"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "multi-mx.{{ primary_zone_name }}"
    type: MX
    exchange: "mail99.{{ primary_zone_name }}"
    preference: 5
    state: absent
  register: mx_selective_delete_result

- name: "Test 5.2: Assert selective deletion succeeded"
  ansible.builtin.assert:
    that:
      - mx_selective_delete_result is changed

- name: "Test 5.3: Verify only one MX record remains"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "multi-mx.{{ primary_zone_name }}"
  register: mx_after_selective_result

- name: "Test 5.4: Assert only the backup MX record remains"
  ansible.builtin.assert:
    that:
      - mx_after_selective_result.records | selectattr('type', 'equalto', 'MX') | list | length == 1
      - (mx_after_selective_result.records | selectattr('type', 'equalto', 'MX') | list | first).rData.preference == 50

# Test 6: Delete all MX records by name and type
- name: "Test 6.1: Delete all MX records for name"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "multi-mx.{{ primary_zone_name }}"
    type: MX
    state: absent
  register: mx_delete_all_result

- name: "Test 6.2: Assert all MX records deleted"
  ansible.builtin.assert:
    that:
      - mx_delete_all_result is changed

- name: "Test 6.3: Verify no MX records remain"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "multi-mx.{{ primary_zone_name }}"
  register: mx_after_delete_all_result
  ignore_errors: true

- name: "Test 6.4: Assert domain has no records or doesn't exist"
  ansible.builtin.assert:
    that:
      - mx_after_delete_all_result.failed or (mx_after_delete_all_result.records | selectattr('type', 'equalto', 'MX') | list | length == 0)

# Test 7: Check mode
- name: "Test 7.1: Create MX record in check mode"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "check-mode-mx.{{ primary_zone_name }}"
    type: MX
    exchange: "mail.{{ primary_zone_name }}"
    preference: 10
    state: present
  check_mode: true
  register: mx_check_create_result

- name: "Test 7.2: Assert check mode reports change"
  ansible.builtin.assert:
    that:
      - mx_check_create_result is changed

- name: "Test 7.3: Verify MX record was not actually created"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "check-mode-mx.{{ primary_zone_name }}"
  register: mx_check_verify_result
  ignore_errors: true

- name: "Test 7.4: Assert record does not exist"
  ansible.builtin.assert:
    that:
      - mx_check_verify_result.failed or (mx_check_verify_result.records | default([]) | length == 0)

- name: "Test 7.5: Actually create the MX record for next test"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "check-mode-mx.{{ primary_zone_name }}"
    type: MX
    exchange: "mail.{{ primary_zone_name }}"
    preference: 10
    state: present

- name: "Test 7.6: Delete MX record in check mode"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "check-mode-mx.{{ primary_zone_name }}"
    type: MX
    state: absent
  check_mode: true
  register: mx_check_delete_result

- name: "Test 7.7: Assert check mode reports would delete"
  ansible.builtin.assert:
    that:
      - mx_check_delete_result is changed

- name: "Test 7.8: Verify MX record still exists"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "check-mode-mx.{{ primary_zone_name }}"
  register: mx_check_still_exists_result

- name: "Test 7.9: Assert record still exists after check mode delete"
  ansible.builtin.assert:
    that:
      - mx_check_still_exists_result.records | selectattr('type', 'equalto', 'MX') | list | length == 1

# Test 8: MX records with TTL and comments
- name: "Test 8.1: Create MX record with custom TTL and comments"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "mx-with-meta.{{ primary_zone_name }}"
    type: MX
    exchange: "mail.{{ primary_zone_name }}"
    preference: 10
    ttl: 7200
    comments: "Primary mail server"
    state: present
  register: mx_meta_result

- name: "Test 8.2: Assert MX record with metadata was created"
  ansible.builtin.assert:
    that:
      - mx_meta_result is changed

- name: "Test 8.3: Verify MX record has correct TTL and comments"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "mx-with-meta.{{ primary_zone_name }}"
  register: mx_meta_get_result

- name: "Test 8.4: Assert MX record metadata is correct"
  ansible.builtin.assert:
    that:
      - (mx_meta_get_result.records | selectattr('type', 'equalto', 'MX') | list | first).ttl == 7200
      - (mx_meta_get_result.records | selectattr('type', 'equalto', 'MX') | list | first).comments == "Primary mail server"

# Test 9: MX record with expiryTtl (auto-expiration)
- name: "Test 9.1: Create MX record with expiryTtl for auto-deletion"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "expiry-mx.{{ primary_zone_name }}"
    type: MX
    exchange: "temp-mail.{{ primary_zone_name }}"
    preference: 10
    expiryTtl: 300
    comments: "Temporary mail server - expires in 5 minutes"
    state: present
  register: mx_expiry_result

- name: "Test 9.2: Assert MX record with expiryTtl was created"
  ansible.builtin.assert:
    that:
      - mx_expiry_result is changed

- name: "Test 9.3: Verify MX record has expiryTtl set"
  effectivelywild.technitium_dns.technitium_dns_get_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "expiry-mx.{{ primary_zone_name }}"
  register: mx_expiry_get_result

- name: "Test 9.4: Assert MX record has correct expiryTtl"
  ansible.builtin.assert:
    that:
      - mx_expiry_get_result.records | selectattr('type', 'equalto', 'MX') | list | length == 1
      - (mx_expiry_get_result.records | selectattr('type', 'equalto', 'MX') | list | first).expiryTtl == 300

- name: "Test 9.5: Create MX record in DNSSEC-enabled zone"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "dnssec-test.{{ primary_sec_zone_name }}"
    zone: "{{ primary_sec_zone_name }}"
    type: MX
    exchange: "mail.{{ primary_zone_name }}"
    preference: 10
    state: present
  register: test9_dnssec_create

- name: "Test 9.5: Assert DNSSEC zone record created"
  ansible.builtin.assert:
    that:
      - test9_dnssec_create is changed

- name: "Test 9.5: Cleanup DNSSEC zone test"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "dnssec-test.{{ primary_sec_zone_name }}"
    zone: "{{ primary_sec_zone_name }}"
    type: MX
    state: absent

# Test 10: Negative tests - validation errors
- name: "Test 10.1: Attempt to create MX record without exchange"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "invalid-mx.{{ primary_zone_name }}"
    type: MX
    preference: 10
    state: present
  register: mx_no_exchange_result
  ignore_errors: true

- name: "Test 10.2: Assert error for missing exchange field"
  ansible.builtin.assert:
    that:
      - mx_no_exchange_result is failed
      - "'exchange' in mx_no_exchange_result.msg"

- name: "Test 10.3: Attempt to create MX record without preference"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "invalid-mx.{{ primary_zone_name }}"
    type: MX
    exchange: "mail.{{ primary_zone_name }}"
    state: present
  register: mx_no_preference_result
  ignore_errors: true

- name: "Test 10.4: Assert error for missing preference field"
  ansible.builtin.assert:
    that:
      - mx_no_preference_result is failed
      - "'preference' in mx_no_preference_result.msg"

- name: "Test 10.5: Attempt to create MX record with unsupported field"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "invalid-mx.{{ primary_zone_name }}"
    type: MX
    exchange: "mail.{{ primary_zone_name }}"
    preference: 10
    ipAddress: "192.0.2.1"
    state: present
  register: mx_bad_field_result
  ignore_errors: true

- name: "Test 10.6: Assert error for unsupported field"
  ansible.builtin.assert:
    that:
      - mx_bad_field_result is failed
      - "'ipAddress' in mx_bad_field_result.msg"

# Cleanup
- name: "Cleanup: Remove all test MX records"
  effectivelywild.technitium_dns.technitium_dns_record:
    api_url: "{{ technitium_api_url_2 | default('http://localhost') }}"
    api_token: "{{ technitium_api_token_2 }}"
    api_port: "{{ technitium_api_port_2 | default(5380) }}"
    name: "{{ item }}"
    type: MX
    state: absent
  loop:
    - "mail-test.{{ primary_zone_name }}"
    - "multi-mx.{{ primary_zone_name }}"
    - "check-mode-mx.{{ primary_zone_name }}"
    - "mx-with-meta.{{ primary_zone_name }}"
    - "expiry-mx.{{ primary_zone_name }}"
  ignore_errors: true
