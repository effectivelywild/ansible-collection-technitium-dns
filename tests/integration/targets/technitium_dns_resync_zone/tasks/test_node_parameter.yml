---
# Integration tests for technitium_dns_resync_zone node parameter (cluster support)

# Setup testing environment with cluster initialization
- name: Include setup_cluster_testing_environment for setup
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "setup"
    initialize_cluster: true

# Note: This test creates a primary zone on cluster_primary_01, then creates a
# secondary zone on cluster_primary_01 that pulls from itself to test resync.
# We only test on cluster_primary_01 since operations on secondary nodes require
# direct authentication to those nodes.

# Setup: Create a primary zone on cluster_primary_01
- name: Create primary zone on cluster_primary_01
  technitium_dns_create_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-resync.local"
    type: "Primary"
    node: "cluster-primary01.example.com"

- name: Configure zone to allow all zone transfers
  technitium_dns_set_zone_options:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-resync.local"
    zoneTransfer: "Allow"
    node: "cluster-primary01.example.com"

- name: Add a record to the primary zone
  technitium_dns_add_record:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "test-resync.local"
    domain: "test-resync.local"
    type: "A"
    ipAddress: "1.2.3.4"
    node: "cluster-primary01.example.com"

- name: Create stub zone on cluster_secondary_01 that pulls from primary zone
  technitium_dns_create_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_secondary_01 }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    zone: "test-resync.local"
    type: "Stub"
    primaryNameServerAddresses: ["cluster-primary01.example.com"]
    node: "cluster-secondary01.example.com"

- name: Wait for initial zone transfer
  pause:
    seconds: 3

# Test 1: Resync stub zone on secondary node (explicit node parameter)
- name: Resync stub zone on secondary node
  technitium_dns_resync_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_secondary_01 }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    zone: "test-resync.local"
    node: "cluster-secondary01.example.com"
  register: resync_primary

- name: Assert resync on secondary node succeeded
  assert:
    that:
      - not resync_primary.failed
      - resync_primary.changed
    fail_msg: "Resync zone on primary node should succeed"

# Test 2: Negative test - invalid node name
- name: Try to resync with invalid node name
  technitium_dns_resync_zone:
    api_url: http://localhost
    api_token: "{{ token_cluster_secondary_01 }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    zone: "test-resync.local"
    node: "invalid-node-name-xyz"
    validate_certs: no
  register: resync_invalid_node
  ignore_errors: true

- name: Assert resync with invalid node fails
  assert:
    that:
      - resync_invalid_node.failed
      - "'No such node exists' in resync_invalid_node.msg"
    fail_msg: "Resync with invalid node name should fail with appropriate error"

- name: Include setup_cluster_testing_environment for teardown
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "teardown"
