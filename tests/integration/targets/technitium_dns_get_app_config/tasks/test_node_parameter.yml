---
# Integration tests for technitium_dns_get_app_config node parameter (cluster support)

# Setup testing environment with cluster initialization
- name: Include setup_cluster_testing_environment for setup
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "setup"
    initialize_cluster: true

- name: "List store apps to get Advanced Blocking URL"
  technitium_dns_list_store_apps:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
  register: store_apps_list

- name: "Debug store_apps_list"
  ansible.builtin.debug:
    var: store_apps_list
  when: debug | default(false)

- name: "Download and install Advanced Blocking app"
  technitium_dns_download_and_install_app:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "Advanced Blocking"
    url: "{{ (store_apps_list.store_apps | selectattr('name', 'equalto', 'Advanced Blocking') | first).url }}"
  register: install_result
  when: store_apps_list.store_apps | selectattr('name', 'equalto', 'Advanced Blocking') | list | length > 0
  retries: 3
  delay: 30
  until: install_result is success

# Test 1: Get app config without node parameter (default behavior)
- name: Get app config without node parameter
  technitium_dns_get_app_config:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "Advanced Blocking"
    validate_certs: no
  register: config_default

- name: Assert default app config returned
  assert:
    that:
      - not config_default.failed
      - config_default.config is defined
    fail_msg: "App config retrieval without node parameter should succeed"

# Test 2: Get app config with explicit node parameter (primary node)
- name: Get app config for primary node
  technitium_dns_get_app_config:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "Advanced Blocking"
    node: "cluster-primary01.example.com"
    validate_certs: no
  register: config_primary

- name: Assert primary node app config returned
  assert:
    that:
      - not config_primary.failed
      - config_primary.config is defined
    fail_msg: "App config retrieval for primary node should succeed"

# Cleanup
- name: Include setup_cluster_testing_environment for teardown
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "teardown"
