---
# Setup testing environment
- name: Include setup_cluster_testing_environment for setup
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "setup"

# Setup - Initialize cluster and join Secondary
- name: "Setup: Initialize cluster on Primary node (04)"
  effectivelywild.technitium_dns.technitium_dns_init_cluster:
    api_url: "http://localhost"
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    cluster_domain: "example.com"
    primary_node_ip_addresses: 
      - "{{ primary_node_ip_address }}"
  register: init_primary_result

- name: "Setup: Wait for cluster to initialize"
  ansible.builtin.pause:
    seconds: 10

- name: "Setup: Join secondary01 node to cluster"
  effectivelywild.technitium_dns.technitium_dns_init_join_cluster:
    api_url: "http://localhost"
    api_token: "{{ token_cluster_secondary_01 }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    secondary_node_ip_addresses: 
      - "{{ secondary_node_ip_address_01 }}"
    primary_node_ip_address: "{{ primary_node_ip_address }}"
    primary_node_url: "https://cluster_primary01{{ container_suffix }}:{{ https_port_cluster_primary_01 }}/"
    primary_node_username: "{{ admin_username }}"
    primary_node_password: "{{ admin_password }}"
    ignore_certificate_errors: true
  register: join_result

- name: "Setup: Login to Secondary node to get valid token"
  effectivelywild.technitium_dns.technitium_dns_login:
    api_url: "http://localhost"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    username: "{{ admin_username }}"
    password: "{{ admin_password }}"
  register: secondary_login

- name: "Setup: Update token fact for Secondary node"
  ansible.builtin.set_fact:
    token_cluster_secondary_01: "{{ secondary_login.token }}"

- name: "Setup: Wait for initial sync"
  ansible.builtin.pause:
    seconds: 5

- name: "Setup: Verify cluster has 2 nodes (1 Primary, 1 Secondary)"
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: "http://localhost"
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
  register: initial_state

- name: "Setup: Assert cluster is correctly initialized"
  assert:
    that:
      - initial_state.cluster_state.clusterNodes | length == 2
      - initial_state.cluster_state.clusterNodes | selectattr('type', 'equalto', 'Primary') | list | length == 1
      - initial_state.cluster_state.clusterNodes | selectattr('type', 'equalto', 'Secondary') | list | length == 1

# Test 1: Promote Secondary to Primary
- name: "Test 1: Promote secondary01 to Primary"
  effectivelywild.technitium_dns.technitium_dns_promote_secondary:
    api_url: "http://localhost"
    api_token: "{{ token_cluster_secondary_01 }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
  register: promote_result

- name: "Test 1.1: Assert promotion succeeded"
  assert:
    that:
      - promote_result is not failed
      - promote_result.changed == true
      - promote_result.msg == "Successfully promoted to Primary node"
      - promote_result.cluster_state is defined
      - promote_result.cluster_state.clusterInitialized == true

- name: "Test 1.2: Login to newly promoted Primary to get valid token"
  effectivelywild.technitium_dns.technitium_dns_login:
    api_url: "http://localhost"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    username: "{{ admin_username }}"
    password: "{{ admin_password }}"
  register: new_primary_login

- name: "Test 1.3: Update token fact for new Primary"
  ansible.builtin.set_fact:
    token_cluster_secondary_01: "{{ new_primary_login.token }}"

- name: "Test 1.4: Wait for promotion to complete"
  ansible.builtin.pause:
    seconds: 5

# Test 2: Verify new Primary state
- name: "Test 2: Get cluster state from new Primary"
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: "http://localhost"
    api_token: "{{ token_cluster_secondary_01 }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
  register: new_primary_state

- name: Debug new_primary_state
  ansible.builtin.debug:
    var: new_primary_state
  when: debug | default(false)

- name: "Test 2.1: Assert new Primary is the only node"
  assert:
    that:
      - new_primary_state.cluster_state.clusterInitialized == true
      - new_primary_state.cluster_state.clusterNodes | length == 1
      - new_primary_state.cluster_state.clusterNodes[0].type == "Primary"
      - secondary_node_ip_address_01 in new_primary_state.cluster_state.clusterNodes[0].ipAddresses
      - new_primary_state.cluster_state.clusterNodes[0].state == "Self"

# Test 3: Verify old Primary is no longer in cluster
- name: "Test 3: Login to old Primary to check state"
  effectivelywild.technitium_dns.technitium_dns_login:
    api_url: "http://localhost"
    api_port: "{{ api_port_cluster_primary_01 }}"
    username: "{{ admin_username }}"
    password: "{{ admin_password }}"
  register: old_primary_login

- name: "Test 3.1: Get cluster state from old Primary"
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: "http://localhost"
    api_token: "{{ old_primary_login.token }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
  register: old_primary_state

- name: "Test 3.1: Debug old_primary_state"
  ansible.builtin.debug:
    var: old_primary_state
  when: debug | default(false)

- name: "Test 3.2: Assert old Primary is no longer in cluster"
  assert:
    that:
      - old_primary_state.cluster_state.clusterInitialized == false

# Test 4: Check mode
- name: "Test 4: Setup - Delete cluster on test05 (new Primary from Test 1)"
  effectivelywild.technitium_dns.technitium_dns_delete_cluster:
    api_url: "http://localhost"
    api_token: "{{ new_primary_login.token }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"

- name: "Test 4.1: Setup - Delete example.com zone on test05"
  effectivelywild.technitium_dns.technitium_dns_delete_zone:
    api_url: "http://localhost"
    api_token: "{{ new_primary_login.token }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    zone: "example.com"
  ignore_errors: true

- name: "Test 4.2: Setup - Reinitialize cluster for check mode test"
  effectivelywild.technitium_dns.technitium_dns_init_cluster:
    api_url: "http://localhost"
    api_token: "{{ old_primary_login.token }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    cluster_domain: "example.com"
    primary_node_ip_addresses: 
      - "{{ primary_node_ip_address }}"

- name: "Test 4.3: Wait for cluster to initialize"
  ansible.builtin.pause:
    seconds: 10

- name: "Test 4.4: Rejoin secondary01 as Secondary"
  effectivelywild.technitium_dns.technitium_dns_init_join_cluster:
    api_url: "http://localhost"
    api_token: "{{ token_cluster_secondary_01 }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    secondary_node_ip_addresses: 
      - "{{ secondary_node_ip_address_01 }}"
    primary_node_ip_address: "{{ primary_node_ip_address }}"
    primary_node_url: "https://cluster_primary01{{ container_suffix }}:{{ https_port_cluster_primary_01 }}/"
    primary_node_username: "{{ admin_username }}"
    primary_node_password: "{{ admin_password }}"
    ignore_certificate_errors: true

- name: "Test 4.5: Login to rejoined Secondary"
  effectivelywild.technitium_dns.technitium_dns_login:
    api_url: "http://localhost"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    username: "{{ admin_username }}"
    password: "{{ admin_password }}"
  register: secondary_login_test4

- name: "Test 4.6: Update token fact for Secondary"
  ansible.builtin.set_fact:
    token_cluster_secondary_01: "{{ secondary_login_test4.token }}"

- name: "Test 4.7: Wait for sync"
  ansible.builtin.pause:
    seconds: 5

- name: "Test 4.8: Promote Secondary in check mode"
  effectivelywild.technitium_dns.technitium_dns_promote_secondary:
    api_url: "http://localhost"
    api_token: "{{ token_cluster_secondary_01 }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
  check_mode: true
  register: check_mode_result

- name: "Test 4.9: Assert check mode reports changes but doesn't promote"
  assert:
    that:
      - check_mode_result is not failed
      - check_mode_result.changed == true
      - "'Would promote this Secondary node to Primary' in check_mode_result.msg"

- name: "Test 4.10: Verify Secondary was not actually promoted"
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: "http://localhost"
    api_token: "{{ token_cluster_secondary_01 }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
  register: verify_not_promoted

- name: "Test 4.11: Assert Secondary is still Secondary"
  assert:
    that:
      - verify_not_promoted.cluster_state.clusterInitialized == true
      - verify_not_promoted.cluster_state.clusterNodes | length == 2
      - (verify_not_promoted.cluster_state.clusterNodes | selectattr('state', 'equalto', 'Self') | list | first).type == "Secondary"

# Test 5: Negative test - Try to promote from Primary node
- name: "Test 5: Try to promote from Primary node (idempotent)"
  effectivelywild.technitium_dns.technitium_dns_promote_secondary:
    api_url: "http://localhost"
    api_token: "{{ old_primary_login.token }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
  register: negative_primary_result

- name: "Test 5.1: Assert Primary node is idempotent"
  assert:
    that:
      - negative_primary_result is not failed
      - negative_primary_result.changed == false
      - "'already the Primary node' in negative_primary_result.msg"

# Test 6: Negative test - Try to promote when cluster not initialized
- name: "Test 6: Leave cluster on secondary01"
  effectivelywild.technitium_dns.technitium_dns_leave_cluster:
    api_url: "http://localhost"
    api_token: "{{ token_cluster_secondary_01 }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"

- name: "Test 6.1: Try to promote when not in cluster (should fail)"
  effectivelywild.technitium_dns.technitium_dns_promote_secondary:
    api_url: "http://localhost"
    api_token: "{{ token_cluster_secondary_01 }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
  register: negative_uninit_result
  ignore_errors: true

- name: "Test 6.2: Assert failure when not in cluster"
  assert:
    that:
      - negative_uninit_result is failed
      - "'Not part of any cluster' in negative_uninit_result.msg"

# Test 7: Force delete Primary (when Primary is unreachable)
# Note: test05 already left cluster in Test 6, and test04 still has cluster from Test 4
- name: "Test 7: Setup - Delete cluster on test04"
  effectivelywild.technitium_dns.technitium_dns_delete_cluster:
    api_url: "http://localhost"
    api_token: "{{ old_primary_login.token }}"
    api_port: "{{ api_port_cluster_primary_01 }}"

- name: "Test 7.1: Setup - Delete example.com zone on test04"
  effectivelywild.technitium_dns.technitium_dns_delete_zone:
    api_url: "http://localhost"
    api_token: "{{ old_primary_login.token }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    zone: "example.com"
  ignore_errors: true

- name: "Test 7.2: Setup - Reinitialize cluster for force delete test"
  effectivelywild.technitium_dns.technitium_dns_init_cluster:
    api_url: "http://localhost"
    api_token: "{{ old_primary_login.token }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    cluster_domain: "example.com"
    primary_node_ip_addresses: 
      - "{{ primary_node_ip_address }}"

- name: "Test 7.3: Wait for cluster to initialize"
  ansible.builtin.pause:
    seconds: 10

- name: "Test 7.4: Rejoin secondary01 as Secondary"
  effectivelywild.technitium_dns.technitium_dns_init_join_cluster:
    api_url: "http://localhost"
    api_token: "{{ token_cluster_secondary_01 }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    secondary_node_ip_addresses: 
      - "{{ secondary_node_ip_address_01 }}"
    primary_node_ip_address: "{{ primary_node_ip_address }}"
    primary_node_url: "https://cluster_primary01{{ container_suffix }}:{{ https_port_cluster_primary_01 }}/"
    primary_node_username: "{{ admin_username }}"
    primary_node_password: "{{ admin_password }}"
    ignore_certificate_errors: true

- name: "Test 7.5: Login to rejoined Secondary"
  effectivelywild.technitium_dns.technitium_dns_login:
    api_url: "http://localhost"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    username: "{{ admin_username }}"
    password: "{{ admin_password }}"
  register: secondary_login_test7

- name: "Test 7.6: Update token fact for Secondary"
  ansible.builtin.set_fact:
    token_cluster_secondary_01: "{{ secondary_login_test7.token }}"

- name: "Test 7.7: Wait for sync"
  ansible.builtin.pause:
    seconds: 5

- name: "Test 7.8: Promote Secondary with force_delete_primary"
  effectivelywild.technitium_dns.technitium_dns_promote_secondary:
    api_url: "http://localhost"
    api_token: "{{ token_cluster_secondary_01 }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    force_delete_primary: true
  register: force_promote_result

- name: "Test 7.9: Assert promotion with force succeeded"
  assert:
    that:
      - force_promote_result is not failed
      - force_promote_result.changed == true
      - force_promote_result.msg == "Successfully promoted to Primary node"

- name: "Test 7.10: Login to newly promoted Primary"
  effectivelywild.technitium_dns.technitium_dns_login:
    api_url: "http://localhost"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    username: "{{ admin_username }}"
    password: "{{ admin_password }}"
  register: new_primary_login_test7

- name: "Test 7.11: Verify new Primary is standalone"
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: "http://localhost"
    api_token: "{{ new_primary_login_test7.token }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
  register: final_state

- name: "Test 7.12: Assert new Primary is the only node"
  assert:
    that:
      - final_state.cluster_state.clusterInitialized == true
      - final_state.cluster_state.clusterNodes | length == 1
      - final_state.cluster_state.clusterNodes[0].type == "Primary"

# Cleanup
- name: Include setup_cluster_testing_environment for setup
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "teardown"