---
# Setup testing environment
- name: "Setup: Include setup_cluster_testing_environment for setup"
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "setup"
    initialize_cluster: true

- name: "Setup: Get cluster state to capture Secondary node IDs"
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
  register: initial_state

- name: Debug initial_state
  ansible.builtin.debug:
    var: initial_state
  when: debug | default(false)

- name: "Setup: Extract secondary01 node ID"
  ansible.builtin.set_fact:
    secondary_01_node_id: "{{ (initial_state.cluster_state.clusterNodes | selectattr('ipAddresses', 'defined') | selectattr('ipAddresses', 'contains', secondary_node_ip_address_01) | list | first).id | int }}"

- name: "Setup: Extract secondary02 node ID"
  ansible.builtin.set_fact:
    secondary_02_node_id: "{{ (initial_state.cluster_state.clusterNodes | selectattr('ipAddresses', 'defined') | selectattr('ipAddresses', 'contains', secondary_node_ip_address_02) | list | first).id | int }}"

- name: "Setup: Verify cluster has 3 nodes"
  assert:
    that:
      - initial_state.cluster_state.clusterNodes | length == 3
      - initial_state.cluster_state.clusterNodes | selectattr('type', 'equalto', 'Primary') | list | length == 1
      - initial_state.cluster_state.clusterNodes | selectattr('type', 'equalto', 'Secondary') | list | length == 2

# Test 1: Delete secondary01 node
- name: "Test 1: Delete secondary01 node"
  effectivelywild.technitium_dns.technitium_dns_delete_secondary_node:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    secondary_node_id: "{{ secondary_01_node_id | int }}"
  register: delete_result

- name: "Test 1.1: Assert secondary01 was deleted"
  assert:
    that:
      - delete_result is not failed
      - delete_result.changed == true
      - delete_result.cluster_state is defined
      - delete_result.cluster_state.clusterNodes | length == 2
      - delete_result.cluster_state.clusterNodes | selectattr('type', 'equalto', 'Secondary') | list | length == 1
      - delete_result.cluster_state.clusterNodes | selectattr('id', 'equalto', secondary_01_node_id | int) | list | length == 0
      - delete_result.msg == "Secondary node " + (secondary_01_node_id | string) + " deleted successfully"

# Test 2: Verify secondary01 is orphaned (still thinks it's in cluster)
- name: "Test 2: Login to orphaned secondary01 to check state"
  effectivelywild.technitium_dns.technitium_dns_login:
    api_url: http://localhost
    api_port: "{{ api_port_cluster_secondary_01 }}"
    username: "{{ admin_username }}"
    password: "{{ admin_password }}"
  register: orphaned_login

- name: "Test 2.1: Get cluster state from orphaned secondary01"
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: http://localhost
    api_token: "{{ orphaned_login.token }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
  register: orphaned_state
  delay: 30
  retries: 3
  until: orphaned_state is success

- name: "Test 2.2: Assert secondary01 still thinks it's in cluster (orphaned)"
  assert:
    that:
      - orphaned_state.cluster_state.clusterInitialized == true

# Test 3: Idempotency - Try to delete already deleted node
- name: "Test 3: Idempotent - Try to delete secondary01 again"
  effectivelywild.technitium_dns.technitium_dns_delete_secondary_node:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    secondary_node_id: "{{ secondary_01_node_id | int }}"
  register: idempotent_result

- name: "Test 3.1: Assert no changes made (idempotent)"
  assert:
    that:
      - idempotent_result is not failed
      - idempotent_result.changed == false
      - "'not found in cluster' in idempotent_result.msg"

# Test 4: Check mode
- name: "Test 4: Delete secondary02 in check mode"
  effectivelywild.technitium_dns.technitium_dns_delete_secondary_node:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    secondary_node_id: "{{ secondary_02_node_id | int }}"
  check_mode: true
  register: check_mode_result

- name: "Test 4.1: Assert check mode reports changes but doesn't delete"
  assert:
    that:
      - check_mode_result is not failed
      - check_mode_result.changed == true
      - "'Would delete Secondary node' in check_mode_result.msg"

- name: "Test 4.2: Verify secondary02 was not actually deleted"
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
  register: verify_not_deleted

- name: Debug verify_not_deleted
  ansible.builtin.debug:
    var: verify_not_deleted
  when: debug | default(false)

- name: Debug secondary_02_node_id
  ansible.builtin.debug:
    var: secondary_02_node_id
  when: debug | default(false)

- name: "Test 4.3: Assert secondary02 still exists"
  assert:
    that:
      - verify_not_deleted.cluster_state.clusterNodes | selectattr('id', 'equalto', secondary_02_node_id | int) | list | length == 1

# Test 5: Actually delete secondary02
- name: "Test 5: Delete secondary02 node"
  effectivelywild.technitium_dns.technitium_dns_delete_secondary_node:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    secondary_node_id: "{{ secondary_02_node_id | int }}"
  register: delete_result_06

- name: "Test 5.1: Assert secondary02 was deleted"
  assert:
    that:
      - delete_result_06 is not failed
      - delete_result_06.changed == true
      - delete_result_06.cluster_state.clusterNodes | length == 1
      - delete_result_06.cluster_state.clusterNodes[0].type == "Primary"

# Test 6: Negative test - Try to delete from Secondary node
- name: "Test 6: Try to delete from Secondary (orphaned) node (should fail)"
  effectivelywild.technitium_dns.technitium_dns_delete_secondary_node:
    api_url: http://localhost
    api_token: "{{ orphaned_login.token }}"
    api_port: "{{ api_port_cluster_secondary_01 }}"
    secondary_node_id: 999999999
  register: negative_secondary_result
  ignore_errors: true

- name: "Test 6.1: Assert failure when trying to delete from Secondary"
  assert:
    that:
      - negative_secondary_result is failed
      - "'not a Primary node' in negative_secondary_result.msg"

# Test 7: Negative test - Try to delete when cluster not initialized
- name: "Test 7: Delete cluster on Primary"
  effectivelywild.technitium_dns.technitium_dns_delete_cluster:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"

- name: "Test 7.1: Try to delete Secondary when cluster not initialized (should fail)"
  effectivelywild.technitium_dns.technitium_dns_delete_secondary_node:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    secondary_node_id: 999999999
  register: negative_uninit_result
  ignore_errors: true

- name: "Test 7.2: Assert failure when cluster not initialized"
  assert:
    that:
      - negative_uninit_result is failed
      - "'Cluster is not initialized' in negative_uninit_result.msg"

# Cleanup
- name: Include setup_cluster_testing_environment for setup
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "teardown"
