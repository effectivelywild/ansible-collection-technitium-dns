---
# Comprehensive integration test suite for technitium_dns clustering
# This test suite validates cluster initialization and state management

# Phase 1: Setup - Load configuration
- name: "Load test configuration"
  include_vars: ../vars/config.yml

- name: "Load cluster test data"
  include_vars: ../vars/cluster_test_data.yml

# Phase 2: Cleanup - Ensure clean state (delete any existing clusters)
- name: "Cleanup - Check if primary cluster exists"
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: "{{ primary_cluster.api_url }}"
    api_token: "{{ primary_cluster.api_token }}"
    api_port: "{{ primary_cluster.api_port }}"
    validate_certs: "{{ validate_certs | default(true) }}"
  register: cleanup_primary_state
  ignore_errors: true

- name: "Debug cleanup state"
  debug:
    var: cleanup_primary_state
  when: debug | default(false)

- name: "Cleanup - Delete existing cluster if initialized"
  effectivelywild.technitium_dns.technitium_dns_delete_cluster:
    api_url: "{{ primary_cluster.api_url }}"
    api_token: "{{ primary_cluster.api_token }}"
    api_port: "{{ primary_cluster.api_port }}"
    validate_certs: "{{ validate_certs | default(true) }}"
    force_delete: true
  when: cleanup_primary_state.cluster_state.clusterInitialized | default(false)
  register: cleanup_delete_result

- name: "Debug cleanup delete result"
  debug:
    var: cleanup_delete_result
  when: debug | default(false) and cleanup_delete_result is defined

# Phase 3: Test get_cluster_state on uninitialized cluster
- name: "Test 1.1: Get cluster state before initialization"
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: "{{ primary_cluster.api_url }}"
    api_token: "{{ primary_cluster.api_token }}"
    api_port: "{{ primary_cluster.api_port }}"
    validate_certs: "{{ validate_certs | default(true) }}"
  register: test1_uninit_state

- name: "Test 1.1: Assert cluster is not initialized"
  assert:
    that:
      - not test1_uninit_state.changed
      - test1_uninit_state.cluster_state is defined
      - test1_uninit_state.cluster_state.clusterInitialized is not defined or not test1_uninit_state.cluster_state.clusterInitialized
    quiet: true
    fail_msg: "Cluster should not be initialized before init_cluster is called"

# Phase 4: Test init_cluster with check_mode
- name: "Test 2.1: Check mode - Initialize cluster"
  effectivelywild.technitium_dns.technitium_dns_init_cluster:
    api_url: "{{ primary_cluster.api_url }}"
    api_token: "{{ primary_cluster.api_token }}"
    api_port: "{{ primary_cluster.api_port }}"
    validate_certs: "{{ validate_certs | default(true) }}"
    cluster_domain: "{{ primary_cluster.domain }}"
    primary_node_ip_address: "{{ primary_cluster.ip_address }}"
  check_mode: true
  register: test2_checkmode_init

- name: "Test 2.1: Assert check mode would make changes"
  assert:
    that:
      - test2_checkmode_init.changed
      - "'Would initialize cluster' in test2_checkmode_init.msg"
    quiet: true
    fail_msg: "Check mode should indicate that changes would be made"

- name: "Test 2.2: Verify cluster was not actually initialized by check mode"
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: "{{ primary_cluster.api_url }}"
    api_token: "{{ primary_cluster.api_token }}"
    api_port: "{{ primary_cluster.api_port }}"
    validate_certs: "{{ validate_certs | default(true) }}"
  register: test2_checkmode_verify

- name: "Test 2.2: Assert cluster still not initialized"
  assert:
    that:
      - test2_checkmode_verify.cluster_state.clusterInitialized is not defined or not test2_checkmode_verify.cluster_state.clusterInitialized
    quiet: true
    fail_msg: "Check mode should not actually initialize the cluster"

# Phase 5: Test init_cluster (actual initialization)
- name: "Test 3.1: Initialize cluster"
  effectivelywild.technitium_dns.technitium_dns_init_cluster:
    api_url: "{{ primary_cluster.api_url }}"
    api_token: "{{ primary_cluster.api_token }}"
    api_port: "{{ primary_cluster.api_port }}"
    validate_certs: "{{ validate_certs | default(true) }}"
    cluster_domain: "{{ primary_cluster.domain }}"
    primary_node_ip_address: "{{ primary_cluster.ip_address }}"
  register: test3_init_result

- name: "Test 3.1: Assert cluster initialized successfully"
  assert:
    that:
      - test3_init_result.changed
      - test3_init_result.cluster_state is defined
      - test3_init_result.cluster_state.clusterInitialized
      - test3_init_result.cluster_state.clusterDomain == primary_cluster.domain
      - test3_init_result.cluster_state.clusterNodes is defined
      - test3_init_result.cluster_state.clusterNodes | length == 1
      - test3_init_result.cluster_state.clusterNodes[0].type == 'Primary'
      - test3_init_result.cluster_state.clusterNodes[0].state == 'Self'
      - test3_init_result.cluster_state.clusterNodes[0].ipAddress == primary_cluster.ip_address
    quiet: true
    fail_msg: "Cluster initialization failed or returned incorrect state"

# Phase 6: Test get_cluster_state after initialization
- name: "Test 4.1: Get cluster state after initialization"
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: "{{ primary_cluster.api_url }}"
    api_token: "{{ primary_cluster.api_token }}"
    api_port: "{{ primary_cluster.api_port }}"
    validate_certs: "{{ validate_certs | default(true) }}"
  register: test4_init_state

- name: "Test 4.1: Assert cluster state is correct"
  assert:
    that:
      - not test4_init_state.changed
      - test4_init_state.cluster_state.clusterInitialized
      - test4_init_state.cluster_state.clusterDomain == primary_cluster.domain
      - test4_init_state.cluster_state.heartbeatRefreshIntervalSeconds is defined
      - test4_init_state.cluster_state.heartbeatRetryIntervalSeconds is defined
      - test4_init_state.cluster_state.configRefreshIntervalSeconds is defined
      - test4_init_state.cluster_state.configRetryIntervalSeconds is defined
      - test4_init_state.cluster_state.clusterNodes | length == 1
    quiet: true

- name: "Test 4.2: Get cluster state with server IP addresses"
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: "{{ primary_cluster.api_url }}"
    api_token: "{{ primary_cluster.api_token }}"
    api_port: "{{ primary_cluster.api_port }}"
    validate_certs: "{{ validate_certs | default(true) }}"
    include_server_ip_addresses: true
  register: test4_state_with_ips

- name: "Test 4.2: Assert server IP addresses are returned"
  assert:
    that:
      - test4_state_with_ips.cluster_state.serverIpAddresses is defined
      - test4_state_with_ips.cluster_state.serverIpAddresses is iterable
      - test4_state_with_ips.cluster_state.serverIpAddresses | length > 0
    quiet: true

# Phase 7: Test idempotency - init_cluster on already initialized cluster
- name: "Test 5.1: Idempotency - Check mode - Initialize cluster again"
  effectivelywild.technitium_dns.technitium_dns_init_cluster:
    api_url: "{{ primary_cluster.api_url }}"
    api_token: "{{ primary_cluster.api_token }}"
    api_port: "{{ primary_cluster.api_port }}"
    validate_certs: "{{ validate_certs | default(true) }}"
    cluster_domain: "{{ primary_cluster.domain }}"
    primary_node_ip_address: "{{ primary_cluster.ip_address }}"
  check_mode: true
  register: test5_idempotent_checkmode

- name: "Test 5.1: Assert no changes needed in check mode"
  assert:
    that:
      - not test5_idempotent_checkmode.changed
      - "'already initialized' in test5_idempotent_checkmode.msg"
    quiet: true

- name: "Test 5.2: Idempotency - Initialize cluster again"
  effectivelywild.technitium_dns.technitium_dns_init_cluster:
    api_url: "{{ primary_cluster.api_url }}"
    api_token: "{{ primary_cluster.api_token }}"
    api_port: "{{ primary_cluster.api_port }}"
    validate_certs: "{{ validate_certs | default(true) }}"
    cluster_domain: "{{ primary_cluster.domain }}"
    primary_node_ip_address: "{{ primary_cluster.ip_address }}"
  register: test5_idempotent

- name: "Test 5.2: Assert no changes made"
  assert:
    that:
      - not test5_idempotent.changed
      - "'already initialized' in test5_idempotent.msg"
    quiet: true

# Phase 8: Test failure cases
- name: "Test 6.1: Attempt to initialize with different domain"
  effectivelywild.technitium_dns.technitium_dns_init_cluster:
    api_url: "{{ primary_cluster.api_url }}"
    api_token: "{{ primary_cluster.api_token }}"
    api_port: "{{ primary_cluster.api_port }}"
    validate_certs: "{{ validate_certs | default(true) }}"
    cluster_domain: "different-domain.{{ testing_suffix }}"
    primary_node_ip_address: "{{ primary_cluster.ip_address }}"
  register: test6_different_domain
  ignore_errors: true

- name: "Test 6.1: Assert initialization with different domain fails"
  assert:
    that:
      - test6_different_domain.failed
      - "'already initialized with different domain' in test6_different_domain.msg"
    quiet: true
    fail_msg: "Should not allow changing cluster domain"

- name: "Test 6.2: Attempt to initialize with different IP address"
  effectivelywild.technitium_dns.technitium_dns_init_cluster:
    api_url: "{{ primary_cluster.api_url }}"
    api_token: "{{ primary_cluster.api_token }}"
    api_port: "{{ primary_cluster.api_port }}"
    validate_certs: "{{ validate_certs | default(true) }}"
    cluster_domain: "{{ primary_cluster.domain }}"
    primary_node_ip_address: "10.0.0.99"
  register: test6_different_ip
  ignore_errors: true

- name: "Test 6.2: Assert initialization with different IP fails"
  assert:
    that:
      - test6_different_ip.failed
      - "'different IP address' in test6_different_ip.msg"
    quiet: true
    fail_msg: "Should not allow changing cluster IP address"

- name: "Test 6.3: Get cluster state with invalid token"
  effectivelywild.technitium_dns.technitium_dns_get_cluster_state:
    api_url: "{{ primary_cluster.api_url }}"
    api_token: "invalid-token-12345"
    api_port: "{{ primary_cluster.api_port }}"
    validate_certs: "{{ validate_certs | default(true) }}"
  register: test6_invalid_token
  ignore_errors: true

- name: "Test 6.3: Assert invalid token fails"
  assert:
    that:
      - test6_invalid_token.failed
    quiet: true
    fail_msg: "Invalid token should fail"
