---
# Integration tests for technitium_dns_query_logs node parameter (cluster support)

# Note: Log operations with node parameter targeting secondary nodes require
# direct authentication to those nodes. Only testing primary node operations here.

# Setup testing environment with cluster initialization
- name: Include setup_cluster_testing_environment for setup
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "setup"
    initialize_cluster: true

# Install Query Logs (Sqlite) app to enable log querying
- name: List all store apps
  technitium_dns_list_store_apps:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    validate_certs: no
  register: store_apps_list

- name: Find Query Logs (Sqlite) app in store
  set_fact:
    query_logs_app: "{{ store_apps_list.store_apps | selectattr('name', 'equalto', 'Query Logs (Sqlite)') | first }}"
  when: store_apps_list.store_apps | selectattr('name', 'equalto', 'Query Logs (Sqlite)') | list | length > 0

- name: Install Query Logs (Sqlite) app
  technitium_dns_download_and_install_app:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    validate_certs: no
    name: "{{ query_logs_app.name }}"
    url: "{{ query_logs_app.url }}"
  register: install_app_result
  retries: 3
  delay: 30
  until: install_app_result is success
  when: query_logs_app is defined

- name: Pause after app installation
  pause:
    seconds: 3
  when: query_logs_app is defined

- name: List installed apps to get classPath
  technitium_dns_list_apps:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    validate_certs: no
  register: installed_apps_list
  when: query_logs_app is defined

- name: Find Query Logs app and extract classPath
  set_fact:
    query_logger_class_path: "{{ item.dnsApps | selectattr('isQueryLogger', 'equalto', true) | map(attribute='classPath') | first }}"
  loop: "{{ installed_apps_list.apps }}"
  when: query_logs_app is defined

# Perform a DNS query to generate log entries
- name: Perform DNS query to technitium.com
  command: docker exec cluster_primary01{{ container_suffix }} dig @localhost technitium.com +short
  delegate_to: localhost
  register: dns_query_result
  ignore_errors: true
  when: query_logs_app is defined

- name: Pause to ensure query is logged
  pause:
    seconds: 10
  when: query_logs_app is defined

# Test 1: Query logs on primary node with explicit node parameter
- name: Query logs on primary node
  technitium_dns_query_logs:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "Query Logs (Sqlite)"
    class_path: "{{ query_logger_class_path }}"
    page_number: 1
    entries_per_page: 50
    node: "cluster-primary01.example.com"
    validate_certs: no
  register: query_logs_primary
  when: query_logs_app is defined

- name: Assert query logs on primary node succeeded
  assert:
    that:
      - not query_logs_primary.failed
      - not query_logs_primary.changed
      - query_logs_primary.entries is defined
      - query_logs_primary.page_number is defined
      - query_logs_primary.total_pages is defined
      - query_logs_primary.total_entries is defined
    fail_msg: "Query logs on primary node should succeed and return log entries"
  when: query_logs_app is defined

# Test 2: Query logs with filters on primary node
- name: Query logs with filters on primary node
  technitium_dns_query_logs:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "Query Logs (Sqlite)"
    class_path: "{{ query_logger_class_path }}"
    page_number: 1
    entries_per_page: 10
    descending_order: true
    node: "cluster-primary01.example.com"
    validate_certs: no
  register: query_logs_filtered
  when: query_logs_app is defined

- name: Assert filtered query logs succeeded
  assert:
    that:
      - not query_logs_filtered.failed
      - not query_logs_filtered.changed
      - query_logs_filtered.entries is defined
      - query_logs_filtered.entries | length <= 10
    fail_msg: "Filtered query logs should respect entries_per_page parameter"
  when: query_logs_app is defined

# Test 3: Negative test - invalid node name
- name: Try to query logs with invalid node name
  technitium_dns_query_logs:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    name: "Query Logs (Sqlite)"
    class_path: "{{ query_logger_class_path | default('Test.Class') }}"
    node: "invalid-node-name-xyz"
    validate_certs: no
  register: query_logs_invalid_node
  ignore_errors: true
  when: query_logs_app is defined

- name: Assert query logs with invalid node fails
  assert:
    that:
      - query_logs_invalid_node.failed
      - "'No such node exists' in query_logs_invalid_node.msg"
    fail_msg: "Query logs with invalid node name should fail with appropriate error"
  when: query_logs_app is defined

# Cleanup - Uninstall the Query Logs app
- name: Uninstall Query Logs (Sqlite) app
  technitium_dns_uninstall_app:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    validate_certs: no
    name: "Query Logs (Sqlite)"
  register: uninstall_app_result
  when: query_logs_app is defined

- name: Include setup_cluster_testing_environment for teardown
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "teardown"
