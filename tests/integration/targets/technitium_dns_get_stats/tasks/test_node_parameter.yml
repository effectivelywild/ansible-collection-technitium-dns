---
# Integration tests for technitium_dns_get_stats node parameter (cluster support)

# Setup testing environment
- name: Include setup_cluster_testing_environment for setup
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "setup"

# Test 1: Get stats without node parameter (default behavior - current node)
- name: Get stats without node parameter
  technitium_dns_get_stats:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    validate_certs: no
  register: stats_default

- name: Assert default stats returned
  assert:
    that:
      - not stats_default.failed
      - stats_default.stats is defined
      - stats_default.stats.totalQueries is defined
    fail_msg: "Stats retrieval without node parameter should succeed"

# Test 2: Get stats for specific node (secondary)
- name: Get stats for secondary node
  technitium_dns_get_stats:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    node: "cluster_secondary01"
    validate_certs: no
  register: stats_secondary

- name: Assert secondary node stats returned
  assert:
    that:
      - not stats_secondary.failed
      - stats_secondary.stats is defined
      - stats_secondary.stats.totalQueries is defined
    fail_msg: "Stats retrieval for secondary node should succeed"

# Test 3: Get cluster-wide stats (aggregate)
- name: Get cluster-wide statistics
  technitium_dns_get_stats:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    node: "cluster"
    validate_certs: no
  register: stats_cluster

- name: Assert cluster stats returned
  assert:
    that:
      - not stats_cluster.failed
      - stats_cluster.stats is defined
      - stats_cluster.stats.totalQueries is defined
    fail_msg: "Cluster-wide stats retrieval should succeed"

# Test 4: Get stats for primary node explicitly
- name: Get stats for primary node
  technitium_dns_get_stats:
    api_url: http://localhost
    api_token: "{{ token_cluster_primary_01 }}"
    api_port: "{{ api_port_cluster_primary_01 }}"
    node: "cluster_primary01"
    validate_certs: no
  register: stats_primary

- name: Assert primary node stats returned
  assert:
    that:
      - not stats_primary.failed
      - stats_primary.stats is defined
      - stats_primary.stats.totalQueries is defined
    fail_msg: "Stats retrieval for primary node should succeed"

# Cleanup
- name: Include setup_cluster_testing_environment for teardown
  ansible.builtin.include_role:
    name: effectivelywild.technitium_dns.setup_cluster_testing_environment
  vars:
    action: "teardown"
